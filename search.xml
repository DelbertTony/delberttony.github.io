<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>RHOSP13实验手册</title>
    <url>/2022/06/05/RHOSP13%E5%AE%9E%E9%AA%8C%E6%89%8B%E5%86%8C/</url>
    <content><![CDATA[<h1>RHOSP13实验手册</h1>
<h2 id="第一章-红帽Openstack平台架构">第一章 红帽Openstack平台架构</h2>
<h3 id="第一节-介绍">第一节 介绍</h3>
<img src="/2022/06/05/RHOSP13%E5%AE%9E%E9%AA%8C%E6%89%8B%E5%86%8C/image-20220606112025776.png" class title="实验环境">
<span id="more"></span>
<ul>
<li>课程中使用power节点模拟虚拟机电源管理。</li>
<li>power节点中CLI接口，创建虚拟主板管理控制器（BMC），通过hypervisor来使用IPMI协议管理每个RHOSP虚拟机，以模拟裸机管理方式。</li>
<li>每台虚拟机都需要一个虚拟BMC，各自在 623 端口上监听power 节点的 BMC 配置，如下所示：</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@power ~<span class="token punctuation">]</span><span class="token comment"># netstat -tulnp | grep 623</span>
udp        <span class="token number">0</span>      <span class="token number">0</span> <span class="token number">172.25</span>.249.112:623      <span class="token number">0.0</span>.0.0:*                           <span class="token number">1259</span>/python         
udp        <span class="token number">0</span>      <span class="token number">0</span> <span class="token number">172.25</span>.249.106:623      <span class="token number">0.0</span>.0.0:*                           <span class="token number">1246</span>/python         
udp        <span class="token number">0</span>      <span class="token number">0</span> <span class="token number">172.25</span>.249.103:623      <span class="token number">0.0</span>.0.0:*                           <span class="token number">1233</span>/python         
udp        <span class="token number">0</span>      <span class="token number">0</span> <span class="token number">172.25</span>.249.102:623      <span class="token number">0.0</span>.0.0:*                           <span class="token number">1220</span>/python         
udp        <span class="token number">0</span>      <span class="token number">0</span> <span class="token number">172.25</span>.249.101:623      <span class="token number">0.0</span>.0.0:*                           <span class="token number">1204</span>/python  
<span class="token punctuation">[</span>root@power ~<span class="token punctuation">]</span><span class="token comment"># cat /etc/bmc/vms</span>
<span class="token comment"># List the VMs that the fake ipmi will manage. Include in the list one</span>
<span class="token comment"># VM name per line along with the proxy IP the IPMI client (ipmitool)</span>
<span class="token comment"># will use to manage it.</span>
<span class="token comment">#</span>
<span class="token comment"># EXAMPLE: VM_NAME,IP_ADDRESS</span>
controller0,172.25.249.101
compute0,172.25.249.102
ceph0,172.25.249.103
computehci0,172.25.249.106
compute1,172.25.249.112
<span class="token comment">#远程控制开关机</span>
<span class="token punctuation">(</span>undercloud<span class="token punctuation">)</span> <span class="token punctuation">[</span>stack@director ~<span class="token punctuation">]</span>$ ipmitool -I lanplus -U admin -P password -H <span class="token number">172.25</span>.249.112 power on<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>查看undercloud的部署镜像</strong></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">(</span>undercloud<span class="token punctuation">)</span> <span class="token punctuation">[</span>stack@director ~<span class="token punctuation">]</span>$ openstack image list
+--------------------------------------+------------------------+--------+
<span class="token operator">|</span> ID                                   <span class="token operator">|</span> Name                   <span class="token operator">|</span> Status <span class="token operator">|</span>
+--------------------------------------+------------------------+--------+
<span class="token operator">|</span> fab32297-d1e2-4598-9e4e-6b02c8982c6f <span class="token operator">|</span> bm-deploy-kernel       <span class="token operator">|</span> active <span class="token operator">|</span>
<span class="token operator">|</span> bc8408a7-3074-4c56-8992-a56637f561e0 <span class="token operator">|</span> bm-deploy-ramdisk      <span class="token operator">|</span> active <span class="token operator">|</span>
<span class="token operator">|</span> ff82c9a3-eead-489f-a862-ca7b2b245a60 <span class="token operator">|</span> overcloud-full         <span class="token operator">|</span> active <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">86901767</span>-c252-4711-867e-a06eb52b4bfc <span class="token operator">|</span> overcloud-full-initrd  <span class="token operator">|</span> active <span class="token operator">|</span>
<span class="token operator">|</span> 4b823922-4757-468f-aad4-1e7bf0f585fa <span class="token operator">|</span> overcloud-full-vmlinuz <span class="token operator">|</span> active <span class="token operator">|</span>
+--------------------------------------+------------------------+--------+<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>bm-deploy-kernel和bm-deploy-ramdisk 是用来引导操作系统启动的镜像，overcloud中的服务器 第一次启动就会使用这两个镜像，做服务器体检，获得服务器的信息，交给ironic服务的数据库，然后将服务器关机。</li>
<li>系统第二次启动会使用overcloud-full-initrd 和overcloud-full-vmlinuz，将服务器再次启动。</li>
<li>服务器启动后，在硬盘上注入overcloud-full这个镜像，然后根据ks脚本将服务器部署成为是控制节点还是计算节点。overcloud-full镜像不仅包含了系统，还包含了ceph和openstack所有的软件包，根据heat编排，将各节点部署成为各个角色。</li>
</ul>
<h3 id="第二节-OpenStack-服务组件通信故障排除方法">第二节 OpenStack 服务组件通信故障排除方法</h3>
<ol>
<li>通过查看 Keystone 日志文件定位故障：/var/log/contaners/keystone/keystone.log</li>
<li>通过查看 RabbitMQ 消息代理定位故障（oslo）</li>
<li>通过查看各服务的 API 日志信息定位故障：/var/log/containers//api.log</li>
<li>通过查看各服务组件的日志信息定位故障</li>
</ol>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">openstack catalog service_name --debug
<span class="token comment">#举例：</span>
openstack catalog nova --debug
openstack catalog show nova --debug<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="第二章-描述openstack控制平面">第二章 描述openstack控制平面</h2>
<h3 id="第一节-RabbitMQ消息队列">第一节 RabbitMQ消息队列</h3>
<p>rabbitmqctl 命令：因为 OpenStack 已经容器化运行，所有的RabbitMQ命令必须在容器内部运行典型rabbitmqctl 命令使用如下：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">rabbitmqctl report：查看 RabbitMQ 守护进程的当前状态，包括 Exchange 与 Queue 的类型
及数量
rabbitmqctl list_users：列出 RabbitMQ 用户
rabbitmqctl list_user_permissions guest 列出guest用户的权限
rabbitmqctl list_exchanges：列出 RabbitMQ 守护进程的默认配置的 Exchange
rabbitmqctl list_queues：列出可用的队列及其属性
rabbitmqctl list_consumers：列出所有的消费者及它们订阅的队列<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>追踪RabbitMQ消息，跟踪会增加系统负载，因此请确保在调查完成后禁⽤跟踪：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">rabbitmqctl trace_on：启用追踪
rabbitmqctl trace_off：禁用追踪<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>查看容器中rabbitmq的相关信息</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@controller0 ~<span class="token punctuation">]</span><span class="token comment"># docker ps | grep rabbit</span>
<span class="token punctuation">[</span>root@controller0 ~<span class="token punctuation">]</span><span class="token comment"># docker container exec rabbitmq-bundle-docker-0 rabbitmqctl report</span>
<span class="token punctuation">[</span>root@controller0 ~<span class="token punctuation">]</span><span class="token comment"># docker container exec rabbitmq-bundle-docker-0 rabbitmqctl list_users</span>
<span class="token punctuation">[</span>root@controller0 ~<span class="token punctuation">]</span><span class="token comment"># docker container exec rabbitmq-bundle-docker-0 rabbitmqctl list_exchanges</span>
<span class="token punctuation">[</span>root@controller0 ~<span class="token punctuation">]</span><span class="token comment"># docker container exec rabbitmq-bundle-docker-0 rabbitmqctl list_queues</span>
<span class="token punctuation">[</span>root@controller0 ~<span class="token punctuation">]</span><span class="token comment"># docker container exec rabbitmq-bundle-docker-0 rabbitmqctl list_consumers</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="练习：开启容器中RabbitMQ的追踪服务">练习：开启容器中RabbitMQ的追踪服务</h4>
<p>准备工作</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>student@workstation ~<span class="token punctuation">]</span>$ lab controlplane-message setup<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@controller0 ~<span class="token punctuation">]</span><span class="token comment"># docker exec -t rabbitmq-bundle-docker-0 rabbitmqctl --help</span>
<span class="token punctuation">[</span>root@controller0 ~<span class="token punctuation">]</span><span class="token comment"># docker exec -t rabbitmq-bundle-docker-0 rabbitmqctl --help | grep add</span>
<span class="token comment">#创建用户并赋权</span>
<span class="token punctuation">[</span>root@controller0 ~<span class="token punctuation">]</span><span class="token comment"># docker exec -t rabbitmq-bundle-docker-0 rabbitmqctl add_user user1 redhat</span>
<span class="token punctuation">[</span>root@controller0 ~<span class="token punctuation">]</span><span class="token comment"># docker exec -t rabbitmq-bundle-docker-0 rabbitmqctl set_permissions user1 ".*" ".*" ".*"</span>
<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span>root@controller0 /<span class="token punctuation">]</span><span class="token comment"># rabbitmqctl set_user_tags user1 administrator</span>
<span class="token comment">#开启追踪功能</span>
<span class="token punctuation">[</span>root@controller0 ~<span class="token punctuation">]</span><span class="token comment"># docker exec -t rabbitmq-bundle-docker-0 rabbitmqctl trace_on</span>
<span class="token comment">#查看rabbitmq服务监听在5672端口</span>
<span class="token punctuation">[</span>root@controller0 ~<span class="token punctuation">]</span><span class="token comment"># ss -tulnp | grep :5672</span>
<span class="token comment">#测试追踪服务</span>
<span class="token punctuation">[</span>root@controller0 ~<span class="token punctuation">]</span><span class="token comment"># ./rmq_trace.py -u user1 -p redhat -t 172.24.1.1 > /tmp/rabbit.user</span>
<span class="token punctuation">[</span>student@workstation ~<span class="token punctuation">]</span>$ <span class="token builtin class-name">source</span> developer1-finance-rc
<span class="token punctuation">[</span>student@workstation ~<span class="token punctuation">(</span>developer1-finance<span class="token punctuation">)</span><span class="token punctuation">]</span>$ openstack server create --image rhel7 --flavor default --security-group default --key-name example-keypair --nic net-id<span class="token operator">=</span>finance-network1 finance-server2 --wait
<span class="token comment">#关闭追踪功能</span>
<span class="token punctuation">[</span>root@controller0 ~<span class="token punctuation">]</span><span class="token comment"># docker exec -t rabbitmq-bundle-docker-0 rabbitmqctl trace_off</span>
<span class="token comment">#清空环境</span>
<span class="token punctuation">[</span>student@workstation ~<span class="token punctuation">]</span>$ lab controlplane-message cleanup
<span class="token comment">#说明：</span>
设置用户对何种资源具有配置、写、读的权限通过正则表达式来匹配，这里的资源指的是virtual hosts中的exchanges、queues等，操作包括对资源进行配置、写、读。配置权限可创建、删除、资源并修改资源的行为，写权限可向资源发送消息，读权限从资源获取消息。
如<span class="token string">'^(amq\.gen.*|amq\.default)$'</span>可以匹配server生成的和默认的exchange，<span class="token string">'^$'</span>不匹配任何资源。
set_permissions <span class="token punctuation">[</span>-p <span class="token operator">&lt;</span>vhostpath<span class="token operator">></span><span class="token punctuation">]</span> <span class="token operator">&lt;</span>user<span class="token operator">></span> <span class="token operator">&lt;</span>conf<span class="token operator">></span> <span class="token operator">&lt;</span>write<span class="token operator">></span> <span class="token operator">&lt;</span>read<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="第二节-控制节点的服务">第二节 控制节点的服务</h3>
<p>初始化环境</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>student@workstation ~<span class="token punctuation">]</span>$ lab controlplane-services setup<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h4 id="练习：访问mysql数据库服务">练习：访问mysql数据库服务</h4>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@controller0 ~<span class="token punctuation">]</span><span class="token comment"># docker ps | grep galera</span>
a193b9433e43        <span class="token number">172.25</span>.249.200:8787/rhosp13/openstack-mariadb:pcmklatest               <span class="token string">"/bin/bash /usr/lo..."</span>   <span class="token number">12</span> minutes ago      Up <span class="token number">12</span> minutes                                       galera-bundle-docker-0
<span class="token punctuation">[</span>root@controller0 ~<span class="token punctuation">]</span><span class="token comment"># docker exec -t galera-bundle-docker-0 mysql -u root -e "show databases"</span>
<span class="token punctuation">[</span>root@controller0 ~<span class="token punctuation">]</span><span class="token comment"># docker exec -it galera-bundle-docker-0 /bin/bash</span>
<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span>root@controller0 /<span class="token punctuation">]</span><span class="token comment"># mysql -u root</span>
MariaDB <span class="token punctuation">[</span><span class="token punctuation">(</span>none<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">></span> use keystone<span class="token punctuation">;</span>
MariaDB <span class="token punctuation">[</span>keystone<span class="token punctuation">]</span><span class="token operator">></span> show tables<span class="token punctuation">;</span>
MariaDB <span class="token punctuation">[</span>keystone<span class="token punctuation">]</span><span class="token operator">></span> <span class="token keyword">select</span> * from role<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>查找mysql数据库密码</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@controller0 ~<span class="token punctuation">]</span><span class="token comment"># cd /var/lib/config-data/puppet-generated/mysql/root/</span>
<span class="token punctuation">[</span>root@controller0 root<span class="token punctuation">]</span><span class="token comment"># ls -a</span>
<span class="token builtin class-name">.</span>  <span class="token punctuation">..</span>  .my.cnf
<span class="token punctuation">[</span>root@controller0 root<span class="token punctuation">]</span><span class="token comment"># vim .my.cnf</span>
<span class="token punctuation">[</span>root@controller0 root<span class="token punctuation">]</span><span class="token comment"># cat .my.cnf</span>
<span class="token punctuation">[</span>client<span class="token punctuation">]</span>
<span class="token assign-left variable">user</span><span class="token operator">=</span>root
<span class="token assign-left variable">password</span><span class="token operator">=</span><span class="token string">"dgMgg8QfNM"</span>

<span class="token punctuation">[</span>mysql<span class="token punctuation">]</span>
<span class="token assign-left variable">user</span><span class="token operator">=</span>root
<span class="token assign-left variable">password</span><span class="token operator">=</span><span class="token string">"dgMgg8QfNM"</span>
<span class="token punctuation">[</span>root@controller0 root<span class="token punctuation">]</span><span class="token comment"># ss -tnlp | grep 3306</span>
LISTEN     <span class="token number">0</span>      <span class="token number">128</span>    <span class="token number">172.24</span>.1.1:3306                     *:*                   users:<span class="token variable"><span class="token punctuation">((</span>"mysqld"<span class="token punctuation">,</span>pid<span class="token operator">=</span><span class="token number">15486</span><span class="token punctuation">,</span>fd<span class="token operator">=</span><span class="token number">30</span><span class="token punctuation">))</span></span>
LISTEN     <span class="token number">0</span>      <span class="token number">128</span>    <span class="token number">172.24</span>.1.50:3306                     *:*                   users:<span class="token variable"><span class="token punctuation">((</span>"haproxy"<span class="token punctuation">,</span>pid<span class="token operator">=</span><span class="token number">14658</span><span class="token punctuation">,</span>fd<span class="token operator">=</span><span class="token number">26</span><span class="token punctuation">))</span></span>
<span class="token comment">#用password="dgMgg8QfNM"登录数据库</span>
<span class="token punctuation">[</span>root@controller0 ~<span class="token punctuation">]</span><span class="token comment"># mysql -uroot -pdgMgg8QfNM -h172.24.1.1</span>
MariaDB <span class="token punctuation">[</span><span class="token punctuation">(</span>none<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">></span> show databases<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="练习：查询redis数据库的密码并登录">练习：查询redis数据库的密码并登录</h4>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment">#查看容器的信息</span>
<span class="token punctuation">[</span>root@controller0 ~<span class="token punctuation">]</span><span class="token comment"># docker inspect redis-bundle-docker-0</span>
<span class="token punctuation">[</span>root@controller0 ~<span class="token punctuation">]</span><span class="token comment"># grep -i pass /var/lib/config-data/puppet-generated/redis/etc/redis.conf</span>
或者
<span class="token punctuation">[</span>root@controller0 root<span class="token punctuation">]</span><span class="token comment"># netstat -tulnp | grep redis</span>
tcp        <span class="token number">0</span>      <span class="token number">0</span> <span class="token number">172.24</span>.1.1:6379         <span class="token number">0.0</span>.0.0:*               LISTEN      <span class="token number">16412</span>/redis-server  
<span class="token punctuation">[</span>root@controller0 ~<span class="token punctuation">]</span><span class="token comment"># redis-cli -h 172.24.1.1</span>
<span class="token number">172.24</span>.1.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> AUTH wuTuATnYuMrzJQGj8KxBb6ZAW
OK
<span class="token number">172.24</span>.1.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> KEYS *
 <span class="token number">1</span><span class="token punctuation">)</span> <span class="token string">"_tooz_beats:b05174d4-374f-4aaf-9e73-8f6157782b60"</span>
 <span class="token number">2</span><span class="token punctuation">)</span> <span class="token string">"_tooz_beats:273ca97b-a442-49e1-bead-f31b5666df42"</span>
 <span class="token number">3</span><span class="token punctuation">)</span> <span class="token string">"_tooz_beats:controller0.0.f6f98884-e9a9-457b-80dc-c46626c8d991"</span>
 <span class="token number">4</span><span class="token punctuation">)</span> <span class="token string">"_tooz_group:alarm_evaluator"</span>
 <span class="token number">5</span><span class="token punctuation">)</span> <span class="token string">"_tooz_beats:controller0.0.861c98f2-96fc-4afe-8e89-f1317c9d04f7"</span>
 <span class="token number">6</span><span class="token punctuation">)</span> <span class="token string">"_tooz_group:compute-computehci0.overcloud.example.com"</span>
 <span class="token number">7</span><span class="token punctuation">)</span> <span class="token string">"_tooz_beats:controller0.0.177a2c8d-6cc4-4bb9-ba0f-8b6d5e9ca3dc"</span>
 <span class="token number">8</span><span class="token punctuation">)</span> <span class="token string">"_tooz_beats:4b27447e-a926-4361-912d-1e4fd7765e00"</span>
 <span class="token number">9</span><span class="token punctuation">)</span> <span class="token string">"_tooz_beats:2f21f9f6-8954-4340-8b93-cf58b9c5015d"</span>
<span class="token number">10</span><span class="token punctuation">)</span> <span class="token string">"_tooz_beats:c0a3ae04-a617-4a0f-8c61-181f3cfb2551"</span>
<span class="token number">11</span><span class="token punctuation">)</span> <span class="token string">"_tooz_group:compute-compute0.overcloud.example.com"</span>
<span class="token number">12</span><span class="token punctuation">)</span> <span class="token string">"_tooz_beats:525147c1-767c-43f4-9adf-a3da092fe497"</span>
<span class="token number">13</span><span class="token punctuation">)</span> <span class="token string">"_tooz_beats:2a1a6744-4217-4db6-91f1-ca03780e5655"</span>
<span class="token number">14</span><span class="token punctuation">)</span> <span class="token string">"_tooz_beats:8f983ebd-1639-4126-b4cc-183efb7ee03b"</span>
<span class="token number">15</span><span class="token punctuation">)</span> <span class="token string">"_tooz_groups"</span>
<span class="token number">16</span><span class="token punctuation">)</span> <span class="token string">"_tooz_group:compute-compute1.overcloud.example.com"</span>
<span class="token number">17</span><span class="token punctuation">)</span> <span class="token string">"gnocchi-config"</span>
<span class="token number">18</span><span class="token punctuation">)</span> <span class="token string">"_tooz_group:central-global"</span>
<span class="token number">19</span><span class="token punctuation">)</span> <span class="token string">"_tooz_group:gnocchi-processing"</span>
<span class="token number">20</span><span class="token punctuation">)</span> <span class="token string">"_tooz_beats:4d102120-2c84-4b9a-b263-7da6c243c621"</span>
<span class="token number">21</span><span class="token punctuation">)</span> <span class="token string">"_tooz_beats:eb8bc300-5348-4c11-aa3f-b8a7c7304ac9"</span>
<span class="token number">22</span><span class="token punctuation">)</span> <span class="token string">"_tooz_beats:controller0.0.175fc0dd-4598-46f5-9e88-cf7cf75f2364"</span>
<span class="token number">172.24</span>.1.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> <span class="token builtin class-name">type</span> gnocchi-config
<span class="token builtin class-name">hash</span>
<span class="token number">172.24</span>.1.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> <span class="token builtin class-name">type</span> _tooz_beats:b05174d4-374f-4aaf-9e73-8f6157782b60
string<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>查看集群</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@controller0 ~<span class="token punctuation">]</span><span class="token comment"># pcs resource show</span>
<span class="token punctuation">[</span>root@controller0 ~<span class="token punctuation">]</span><span class="token comment"># pcs resource disable openstack-manila-share</span>
<span class="token punctuation">[</span>root@controller0 ~<span class="token punctuation">]</span><span class="token comment"># pcs resource enable openstack-manila-share</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h4 id="练习：查看vnc登录的地址">练习：查看vnc登录的地址</h4>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>student@workstation ~<span class="token punctuation">]</span>$ <span class="token builtin class-name">source</span> developer1-finance-rc
<span class="token punctuation">[</span>student@workstation ~<span class="token punctuation">(</span>developer1-finance<span class="token punctuation">)</span><span class="token punctuation">]</span>$ openstack console url show finance-server3
+-------+------------------------------------------------------------------------------------+
<span class="token operator">|</span> Field <span class="token operator">|</span> Value                                                                              <span class="token operator">|</span>
+-------+------------------------------------------------------------------------------------+
<span class="token operator">|</span> <span class="token builtin class-name">type</span>  <span class="token operator">|</span> novnc                                                                              <span class="token operator">|</span>
<span class="token operator">|</span> url   <span class="token operator">|</span> http://172.25.250.50:6080/vnc_auto.html?token<span class="token operator">=</span>3f09227e-d49d-41b2-98ed-d61eda6296e5 <span class="token operator">|</span>
+-------+------------------------------------------------------------------------------------+
<span class="token comment">#在控制节点上看监听端口</span>
<span class="token punctuation">[</span>root@controller0 ~<span class="token punctuation">]</span><span class="token comment"># netstat -tulnp | grep 6080</span>
<span class="token punctuation">[</span>root@foundation0 ~<span class="token punctuation">]</span><span class="token comment"># firefox http://172.25.250.50:6080/vnc_auto.html?token=3f09227e-d49d-41b2-98ed-d61eda6296e5</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<img src="/2022/06/05/RHOSP13%E5%AE%9E%E9%AA%8C%E6%89%8B%E5%86%8C/image-20220607212134160.png" class title="vnc">
<p>清空环境</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>student@workstation ~<span class="token punctuation">]</span>$ lab controlplane-services cleanup<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h2 id="第三章-身份认证管理">第三章 身份认证管理</h2>
<h3 id="第一节-管理集成的-IdM-后端配置">第一节 管理集成的 IdM 后端配置</h3>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment">#管理员身份查看用户和域信息</span>
<span class="token punctuation">(</span>undercloud<span class="token punctuation">)</span> <span class="token punctuation">[</span>stack@director ~<span class="token punctuation">]</span>$ <span class="token builtin class-name">source</span> overcloudrc
<span class="token punctuation">(</span>overcloud<span class="token punctuation">)</span> <span class="token punctuation">[</span>stack@director ~<span class="token punctuation">]</span>$ openstack domain list
<span class="token punctuation">(</span>overcloud<span class="token punctuation">)</span> <span class="token punctuation">[</span>stack@director ~<span class="token punctuation">]</span>$ openstack user list --domain Example
<span class="token comment">#查看用户在当前域的token信息</span>
<span class="token punctuation">[</span>student@workstation ~<span class="token punctuation">]</span>$ <span class="token builtin class-name">source</span> developer1-finance-rc
<span class="token punctuation">[</span>student@workstation ~<span class="token punctuation">(</span>developer1-finance<span class="token punctuation">)</span><span class="token punctuation">]</span>$ openstack token issue<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="练习：配置dashboard可以登录其他域的用户">练习：配置dashboard可以登录其他域的用户</h4>
<ol>
<li>配置Horizon控制面板</li>
</ol>
<ul>
<li>
<p>默认情况下，身份认证服务使用default域</p>
</li>
<li>
<p>集成外部认证后端时需要单独创建后端的认证域</p>
</li>
<li>
<p>集成IdM认证后端时，需要在控制节点Horizon控制面板中启用multidomain支持特性</p>
<p>如下所示：</p>
</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@controller0 ~<span class="token punctuation">]</span><span class="token comment"># vim /var/lib/config-data/puppetgenerated/horizon/etc/openstack-dashboard/local_settings</span>
OPENSTACK_KEYSTONE_MULTIDOMAIN_SUPPORT <span class="token operator">=</span> True
<span class="token punctuation">[</span>root@controller0 ~<span class="token punctuation">]</span><span class="token comment"># docker restart horizon</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<ol start="2">
<li>配置身份认证服务：</li>
</ol>
<ul>
<li>编辑Keystone配置文件使dashboard控制面板支持multidomain特性</li>
</ul>
<p>​		如下所示：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@controller0 ~<span class="token punctuation">]</span><span class="token comment"># vim /var/lib/configdata/puppetgenerated/keystone/etc/keystone/keystone.conf</span>
<span class="token punctuation">[</span>identity<span class="token punctuation">]</span>
domain_specific_drivers_enabled <span class="token operator">=</span> <span class="token boolean">true</span>
<span class="token punctuation">[</span>root@controller0 ~<span class="token punctuation">]</span><span class="token comment"># docker restart keystone</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="第二节-管理身份服务令牌">第二节 管理身份服务令牌</h3>
<h4 id="练习：轮转key">练习：轮转key</h4>
<p>参考文档链接：<a href="http://content.example.com/rhosp13.0/x86_64/dvd/docs/html/">http://content.example.com/rhosp13.0/x86_64/dvd/docs/html/</a></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment">#查看轮转前</span>
<span class="token punctuation">[</span>root@controller0 ~<span class="token punctuation">]</span><span class="token comment"># ls /var/lib/config-data/puppet-generated/keystone/etc/keystone/fernet-keys/</span>
<span class="token number">0</span>  <span class="token number">1</span>
<span class="token comment">#轮转可以</span>
<span class="token punctuation">[</span>stack@director ~<span class="token punctuation">]</span>$ <span class="token builtin class-name">source</span> ~/stackrc
<span class="token punctuation">(</span>undercloud<span class="token punctuation">)</span> <span class="token punctuation">[</span>stack@director ~<span class="token punctuation">]</span>$ openstack workflow execution create tripleo.fernet_keys.v1.rotate_fernet_keys <span class="token string">'&#123;"container": "overcloud"&#125;'</span>
<span class="token punctuation">(</span>undercloud<span class="token punctuation">)</span> <span class="token punctuation">[</span>stack@director ~<span class="token punctuation">]</span>$ openstack workflow execution show 7cea4168-d91f-456c-8d9c-2d9bb1200260
<span class="token comment">#查看轮转后</span>
<span class="token punctuation">[</span>root@controller0 ~<span class="token punctuation">]</span><span class="token comment"># ls /var/lib/config-data/puppet-generated/keystone/etc/keystone/fernet-keys/</span>
<span class="token number">0</span>  <span class="token number">1</span>  <span class="token number">2</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="第三节-管理项目组织">第三节 管理项目组织</h3>
<p><strong>域 Domain：</strong></p>
<ul>
<li>Keystone v3（Identity Service v3）的新特性</li>
<li>域包含用户、组与项目</li>
<li>RHOSP 初始安装了 Default 域</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ openstack domain create <span class="token operator">&lt;</span>domain<span class="token operator">></span>：创建额外的域
$ openstack domain list：列出已有的域<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p><strong>用户 User：</strong></p>
<ul>
<li>管理员应该保留 Default 域用于服务账户的使用</li>
<li>管理员可以创建新的域，并加入用户</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ openstack user create <span class="token operator">&lt;</span>user<span class="token operator">></span> --domain <span class="token operator">&lt;</span>domain<span class="token operator">></span> --password-prompt<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>​	说明：指定域添加新的用户，不指定 --domain 选项时，默认为 Default domain；不建议命令行中指定密码，存在安全风险，建议交互式输入密码。</p>
<p><strong>组 Group：</strong></p>
<ul>
<li>Keystone v3 还引入了组的概念</li>
<li>组有利于批量管理用户访问资源</li>
<li>管理员可以对组执行单一操作，并将其作用分发给组中的所有成员</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ openstack group create <span class="token operator">&lt;</span>group<span class="token operator">></span> --domain <span class="token operator">&lt;</span>domain<span class="token operator">></span> <span class="token comment">#指定域创建组</span>
$ openstack group <span class="token function">add</span> user --group-domain <span class="token operator">&lt;</span>group_domain<span class="token operator">></span> --user-domain <span class="token operator">&lt;</span>user_domain<span class="token operator">></span> <span class="token operator">&lt;</span>group<span class="token operator">></span> <span class="token operator">&lt;</span>user<span class="token operator">></span> <span class="token comment">#将域中的用户添加到域中的组中</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p><strong>项目 Project：</strong></p>
<ul>
<li>Keystone v3 引入，用户不再包含于项目中，而是包含于域中，因此用户可从属于多个项目</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ openstack project create <span class="token operator">&lt;</span>project<span class="token operator">></span> --domain <span class="token operator">&lt;</span>domain<span class="token operator">></span> <span class="token comment">#指定域创建项目</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><strong>角色管理：</strong></p>
<ul>
<li>身份认证服务使用基于角色的访问控制（RBAC）来认证授权用户访问 OpenStack</li>
<li>管理员可为用户与组分配角色来授权访问域与项目</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ openstack role <span class="token function">add</span> --domain Example --user admin admin
<span class="token comment">#为 Default 域中的 admin 用户授予 Example 域的 admin 角色</span>
$ openstack role <span class="token function">add</span> --project research --project-domain Example --group developers --group-domain Lab _member_
<span class="token comment">#为 Lab 域的 developers 组授予 Example 域中 research 项⽬的_member_ 角色</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>用户存放在IDM中</strong></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@foundation0 ~<span class="token punctuation">]</span><span class="token comment"># ssh utility</span>
<span class="token punctuation">[</span>student@utility ~<span class="token punctuation">]</span>$ kinit admin
Password <span class="token keyword">for</span> admin@LAB.EXAMPLE.NET: RedHat123^
<span class="token punctuation">[</span>student@utility ~<span class="token punctuation">]</span>$ ipa user-find <span class="token operator">|</span> <span class="token function">grep</span> User
User login: admin
User login: architect1
User login: architect2
User login: architect3
……
<span class="token punctuation">[</span>student@utility ~<span class="token punctuation">]</span>$ ipa group-find <span class="token operator">|</span> <span class="token function">grep</span> Group
Group name: admins
Group name: consulting-admins
Group name: consulting-members
Group name: consulting-swiftoperators
Group name: editors
……<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="练习：配置用户并赋予角色">练习：配置用户并赋予角色</h4>
<ul>
<li>创建 OpenStack 域 210Demo，其中包含 Engineering 与 Production项目</li>
<li>在域 210Demo 中创建 OpenStack 组 Devops，其中需包含以下用户：
<ul>
<li>a. Robert 用户是 Engineering 项目的用户与管理员，email 地址为： <a href="mailto:Robert@lab.example.com">Robert@lab.example.com</a>。</li>
<li>b. George 用户是 Engineering 项目的用户，email 地址为：George@lab.example.com。</li>
<li>c. William 用户是 Production 项目的用户与管理员，email 地址为： <a href="mailto:William@lab.example.com">William@lab.example.com</a>。</li>
<li>d. John 用户是 Production 项目的用户，email 地址为：John@lab.example.com。 所有用户账户的密码都是 redhat</li>
</ul>
</li>
</ul>
<p>登录</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@foundation0 ~<span class="token punctuation">]</span><span class="token comment"># ssh stack@director</span>
<span class="token punctuation">(</span>undercloud<span class="token punctuation">)</span> <span class="token punctuation">[</span>stack@director ~<span class="token punctuation">]</span>$ <span class="token builtin class-name">source</span> overcloudrc<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>创建域</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">(</span>overcloud<span class="token punctuation">)</span> <span class="token punctuation">[</span>stack@director ~<span class="token punctuation">]</span>$ openstack domain create 210Demo<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>创建项目</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">(</span>overcloud<span class="token punctuation">)</span> <span class="token punctuation">[</span>stack@director ~<span class="token punctuation">]</span>$ openstack project create Engineering --domain 210Demo
<span class="token punctuation">(</span>overcloud<span class="token punctuation">)</span> <span class="token punctuation">[</span>stack@director ~<span class="token punctuation">]</span>$ openstack project create Production --domain 210Demo<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>创建组</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">(</span>overcloud<span class="token punctuation">)</span> <span class="token punctuation">[</span>stack@director ~<span class="token punctuation">]</span>$ openstack group create Devops --domain 210Demo<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>创建用户</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">(</span>overcloud<span class="token punctuation">)</span> <span class="token punctuation">[</span>stack@director ~<span class="token punctuation">]</span>$ openstack user create Robert --domain 210Demo --password redhat --project Engineering --project-domain 210Demo --email Robert@lab.example.com
<span class="token punctuation">(</span>overcloud<span class="token punctuation">)</span> <span class="token punctuation">[</span>stack@director ~<span class="token punctuation">]</span>$ openstack user create George --domain 210Demo --password redhat --project Engineering --project-domain 210Demo --email George@lab.example.com
<span class="token punctuation">(</span>overcloud<span class="token punctuation">)</span> <span class="token punctuation">[</span>stack@director ~<span class="token punctuation">]</span>$ openstack user create William --domain 210Demo --password redhat --project Production --project
-domain 210Demo --email William@lab.example.com
<span class="token punctuation">(</span>overcloud<span class="token punctuation">)</span> <span class="token punctuation">[</span>stack@director ~<span class="token punctuation">]</span>$ openstack user create John --domain 210Demo --password redhat --project Production --project-domain 210Demo --email John@lab.example.com<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>给用户赋予角色</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">(</span>overcloud<span class="token punctuation">)</span> <span class="token punctuation">[</span>stack@director ~<span class="token punctuation">]</span>$ openstack role <span class="token function">add</span> --user Robert --user-domain 210Demo --project Engineering --project-domain 210Demo admin
<span class="token punctuation">(</span>overcloud<span class="token punctuation">)</span> <span class="token punctuation">[</span>stack@director ~<span class="token punctuation">]</span>$ openstack role <span class="token function">add</span> --user Robert --user-domain 210Demo --project Engineering --project-domain 210Demo _member_
<span class="token punctuation">(</span>overcloud<span class="token punctuation">)</span> <span class="token punctuation">[</span>stack@director ~<span class="token punctuation">]</span>$ openstack role <span class="token function">add</span> --user George --user-domain 210Demo --project Engineering --project-domain 210Demo _member_
<span class="token punctuation">(</span>overcloud<span class="token punctuation">)</span> <span class="token punctuation">[</span>stack@director ~<span class="token punctuation">]</span>$ openstack role <span class="token function">add</span> --user William --user-domain 210Demo --project Production --project-domain 210Demo admin
<span class="token punctuation">(</span>overcloud<span class="token punctuation">)</span> <span class="token punctuation">[</span>stack@director ~<span class="token punctuation">]</span>$ openstack role <span class="token function">add</span> --user William --user-domain 210Demo --project Production --project-domain 210Demo _member_
<span class="token punctuation">(</span>overcloud<span class="token punctuation">)</span> <span class="token punctuation">[</span>stack@director ~<span class="token punctuation">]</span>$ openstack role <span class="token function">add</span> --user John --user-domain 210Demo --project Production --project-domain 210Demo _member_

<span class="token comment">#验证</span>
<span class="token punctuation">(</span>overcloud<span class="token punctuation">)</span> <span class="token punctuation">[</span>stack@director ~<span class="token punctuation">]</span>$ openstack role assignment list --user Robert --user-domain 210Demo --project Engineering --project-domain 210Demo --names
+----------+----------------+-------+---------------------+--------+-----------+
<span class="token operator">|</span> Role     <span class="token operator">|</span> User           <span class="token operator">|</span> Group <span class="token operator">|</span> Project             <span class="token operator">|</span> Domain <span class="token operator">|</span> Inherited <span class="token operator">|</span>
+----------+----------------+-------+---------------------+--------+-----------+
<span class="token operator">|</span> admin    <span class="token operator">|</span> Robert@210Demo <span class="token operator">|</span>       <span class="token operator">|</span> Engineering@210Demo <span class="token operator">|</span>        <span class="token operator">|</span> False     <span class="token operator">|</span>
<span class="token operator">|</span> _member_ <span class="token operator">|</span> Robert@210Demo <span class="token operator">|</span>       <span class="token operator">|</span> Engineering@210Demo <span class="token operator">|</span>        <span class="token operator">|</span> False     <span class="token operator">|</span>
+----------+----------------+-------+---------------------+--------+-----------+
<span class="token punctuation">(</span>overcloud<span class="token punctuation">)</span> <span class="token punctuation">[</span>stack@director ~<span class="token punctuation">]</span>$ openstack role assignment list --user George --user-domain 210Demo --project Engineering --project-domain 210Demo --names
+----------+----------------+-------+---------------------+--------+-----------+
<span class="token operator">|</span> Role     <span class="token operator">|</span> User           <span class="token operator">|</span> Group <span class="token operator">|</span> Project             <span class="token operator">|</span> Domain <span class="token operator">|</span> Inherited <span class="token operator">|</span>
+----------+----------------+-------+---------------------+--------+-----------+
<span class="token operator">|</span> _member_ <span class="token operator">|</span> George@210Demo <span class="token operator">|</span>       <span class="token operator">|</span> Engineering@210Demo <span class="token operator">|</span>        <span class="token operator">|</span> False     <span class="token operator">|</span>
+----------+----------------+-------+---------------------+--------+-----------+
<span class="token punctuation">(</span>overcloud<span class="token punctuation">)</span> <span class="token punctuation">[</span>stack@director ~<span class="token punctuation">]</span>$ openstack role assignment list --user William --user-domain 210Demo --project Production --project-domain 210Demo --names
+----------+-----------------+-------+--------------------+--------+-----------+
<span class="token operator">|</span> Role     <span class="token operator">|</span> User            <span class="token operator">|</span> Group <span class="token operator">|</span> Project            <span class="token operator">|</span> Domain <span class="token operator">|</span> Inherited <span class="token operator">|</span>
+----------+-----------------+-------+--------------------+--------+-----------+
<span class="token operator">|</span> admin    <span class="token operator">|</span> William@210Demo <span class="token operator">|</span>       <span class="token operator">|</span> Production@210Demo <span class="token operator">|</span>        <span class="token operator">|</span> False     <span class="token operator">|</span>
<span class="token operator">|</span> _member_ <span class="token operator">|</span> William@210Demo <span class="token operator">|</span>       <span class="token operator">|</span> Production@210Demo <span class="token operator">|</span>        <span class="token operator">|</span> False     <span class="token operator">|</span>
+----------+-----------------+-------+--------------------+--------+-----------+
<span class="token punctuation">(</span>overcloud<span class="token punctuation">)</span> <span class="token punctuation">[</span>stack@director ~<span class="token punctuation">]</span>$ openstack role assignment list --user John --user-domain 210Demo --project Production --project-domain 210Demo --names
+----------+--------------+-------+--------------------+--------+-----------+
<span class="token operator">|</span> Role     <span class="token operator">|</span> User         <span class="token operator">|</span> Group <span class="token operator">|</span> Project            <span class="token operator">|</span> Domain <span class="token operator">|</span> Inherited <span class="token operator">|</span>
+----------+--------------+-------+--------------------+--------+-----------+
<span class="token operator">|</span> _member_ <span class="token operator">|</span> John@210Demo <span class="token operator">|</span>       <span class="token operator">|</span> Production@210Demo <span class="token operator">|</span>        <span class="token operator">|</span> False     <span class="token operator">|</span>
+----------+--------------+-------+--------------------+--------+-----------+<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>添加用户到组</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">(</span>overcloud<span class="token punctuation">)</span> <span class="token punctuation">[</span>stack@director ~<span class="token punctuation">]</span>$ openstack group <span class="token function">add</span> user --group-domain 210Demo --user-domain 210Demo Devops Robert
<span class="token punctuation">(</span>overcloud<span class="token punctuation">)</span> <span class="token punctuation">[</span>stack@director ~<span class="token punctuation">]</span>$ openstack group <span class="token function">add</span> user --group-domain 210Demo --user-domain 210Demo Devops George
<span class="token punctuation">(</span>overcloud<span class="token punctuation">)</span> <span class="token punctuation">[</span>stack@director ~<span class="token punctuation">]</span>$ openstack group <span class="token function">add</span> user --group-domain 210Demo --user-domain 210Demo Devops William
<span class="token punctuation">(</span>overcloud<span class="token punctuation">)</span> <span class="token punctuation">[</span>stack@director ~<span class="token punctuation">]</span>$ openstack group <span class="token function">add</span> user --group-domain 210Demo --user-domain 210Demo Devops John<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>给组添加角色</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">(</span>overcloud<span class="token punctuation">)</span> <span class="token punctuation">[</span>stack@director ~<span class="token punctuation">]</span>$ openstack role <span class="token function">add</span> --group Devops --group-domain 210Demo --project Engineering --project-domain 210Demo admin
<span class="token punctuation">(</span>overcloud<span class="token punctuation">)</span> <span class="token punctuation">[</span>stack@director ~<span class="token punctuation">]</span>$ openstack role <span class="token function">add</span> --group Devops --group-domain 210Demo --project Engineering --project-domain 210Demo _member_
<span class="token punctuation">(</span>overcloud<span class="token punctuation">)</span> <span class="token punctuation">[</span>stack@director ~<span class="token punctuation">]</span>$ openstack role <span class="token function">add</span> --group Devops --group-domain 210Demo --project Production --project-domain 210Demo admin
<span class="token punctuation">(</span>overcloud<span class="token punctuation">)</span> <span class="token punctuation">[</span>stack@director ~<span class="token punctuation">]</span>$ openstack role <span class="token function">add</span> --group Devops --group-domain 210Demo --project Production --project-domain 210Demo _member_<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="第四章-镜像管理">第四章 镜像管理</h2>
<h3 id="第一节-比较镜像格式">第一节 比较镜像格式</h3>
<ol>
<li>raw</li>
</ol>
<p>raw格式是最简单，什么都没有，所以叫raw格式。连头文件都没有，就是一个直接给虚拟机进行读写的文件。raw不支持动态增长空间，必须一开始就指定空间大小。所以相当的耗费磁盘空间。但是对于支持稀疏文件的文件系统（如ext4）而言，这方面并不突出。ext4下默认创建的文件就是稀疏文件，所以不要做什么额外的工作。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">du</span> -sh 文件名<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>用du可以查看文件的实际大小。也就是说，不管磁盘空间有多大，运行下面的指令没有任何问题：</p>
<p>raw镜像格式是虚拟机中I/O性能最好的一种格式，大家在使用时都会和raw进行参照，性能越接近raw 的越好。但是raw没有任何其他功能。对于稀疏文件的出现，像qcow这一类的运行时分配空间的镜像就 没有任何优势了。</p>
<ol start="2">
<li>qcow</li>
</ol>
<p>qcow在cow的基础上增加了动态增加文件大小的功能，并且支持加密，压缩。qcow通过2级索引表来管理整个镜像的空间分配，其中第二级的索引用了内存cache技术，需要查找动作，这方面导致性能的损失。qcow现在基本不用，一方面其优化和功能没有qcow2好，另一方面，读写性能又没有cow和raw好。</p>
<ol start="3">
<li>qcow2</li>
</ol>
<p>qcow2是集各种技术为一体的超级镜像格式，支持内部快照，加密，压缩等一系列功能，访问性能也在不断提高。但qcow2的问题就是过于臃肿，把什么功能都集于一身。</p>
<p><strong>镜像文件管理</strong></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment">#创建镜像</span>
<span class="token punctuation">[</span>root@compute0 ~<span class="token punctuation">]</span><span class="token comment"># qemu-img create -f qcow2 disk01.qcow2 10G </span>
Formatting <span class="token string">'disk01.qcow2'</span>, <span class="token assign-left variable">fmt</span><span class="token operator">=</span>qcow2 <span class="token assign-left variable">size</span><span class="token operator">=</span><span class="token number">10737418240</span> <span class="token assign-left variable">cluster_size</span><span class="token operator">=</span><span class="token number">65536</span> <span class="token assign-left variable">lazy_refcounts</span><span class="token operator">=</span>off <span class="token assign-left variable">refcount_bits</span><span class="token operator">=</span><span class="token number">16</span>
<span class="token punctuation">[</span>root@compute0 ~<span class="token punctuation">]</span><span class="token comment"># qemu-img create -f raw disk02.raw 10G</span>
Formatting <span class="token string">'disk02.raw'</span>, <span class="token assign-left variable">fmt</span><span class="token operator">=</span>raw <span class="token assign-left variable">size</span><span class="token operator">=</span><span class="token number">10737418240</span>
<span class="token comment">#查看镜像</span>
<span class="token punctuation">[</span>root@compute0 ~<span class="token punctuation">]</span><span class="token comment"># qemu-img info disk01.qcow2</span>
image: disk01.qcow2
<span class="token function">file</span> format: qcow2
virtual size: 10G <span class="token punctuation">(</span><span class="token number">10737418240</span> bytes<span class="token punctuation">)</span>
disk size: 196K
cluster_size: <span class="token number">65536</span>
Format specific information:
    compat: <span class="token number">1.1</span>
    lazy refcounts: <span class="token boolean">false</span>
    refcount bits: <span class="token number">16</span>
    corrupt: <span class="token boolean">false</span>
<span class="token punctuation">[</span>root@compute0 ~<span class="token punctuation">]</span><span class="token comment"># qemu-img info disk02.raw</span>
image: disk02.raw
<span class="token function">file</span> format: raw
virtual size: 10G <span class="token punctuation">(</span><span class="token number">10737418240</span> bytes<span class="token punctuation">)</span>
disk size: <span class="token number">0</span>
<span class="token punctuation">[</span>root@compute0 ~<span class="token punctuation">]</span><span class="token comment"># ll -h</span>
-rw-r--r--. <span class="token number">1</span> root root 193K Jun <span class="token number">26</span> <span class="token number">11</span>:11 disk01.qcow2
-rw-r--r--. <span class="token number">1</span> root root  10G Jun <span class="token number">26</span> <span class="token number">11</span>:12 disk02.raw
<span class="token comment">#qcow2和raw格式之间进行转换</span>
<span class="token punctuation">[</span>root@compute0 ~<span class="token punctuation">]</span><span class="token comment"># qemu-img convert -f qcow2 -O raw disk01.qcow2 disk01.raw</span>
<span class="token punctuation">[</span>root@compute0 ~<span class="token punctuation">]</span><span class="token comment"># ll -h</span>
-rw-r--r--. <span class="token number">1</span> root root 193K Jun <span class="token number">26</span> <span class="token number">11</span>:11 disk01.qcow2
-rw-r--r--. <span class="token number">1</span> root root  10G Jun <span class="token number">26</span> <span class="token number">11</span>:16 disk01.raw
-rw-r--r--. <span class="token number">1</span> root root  10G Jun <span class="token number">26</span> <span class="token number">11</span>:12 disk02.raw<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="第二节-修改客户机和磁盘镜像">第二节 修改客户机和磁盘镜像</h3>
<h4 id="练习：guestfish自定义镜像">练习：guestfish自定义镜像</h4>
<p>初始化环境</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>student@workstation ~<span class="token punctuation">]</span>$ lab customization-img-customizing setup<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>下载镜像</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>student@workstation ~<span class="token punctuation">(</span>developer1-finance<span class="token punctuation">)</span><span class="token punctuation">]</span>$  <span class="token function">wget</span> http://materials.example.com/osp-small.qcow2 -O ~/finance-rhel-db.qcow2<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>编辑镜像</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>student@workstation ~<span class="token punctuation">(</span>developer1-finance<span class="token punctuation">)</span><span class="token punctuation">]</span>$  guestfish -i --network -a ~/finance-rhel-db.qcow2
<span class="token comment">#选项说明: -i 自动挂载分区；--network 启用网络；-a 添加磁盘镜像</span>
<span class="token operator">></span><span class="token operator">&lt;</span>fs<span class="token operator">></span> <span class="token builtin class-name">command</span> <span class="token string">"yum -y install httpd"</span>
<span class="token operator">></span><span class="token operator">&lt;</span>fs<span class="token operator">></span> <span class="token builtin class-name">command</span> <span class="token string">"systemctl enable httpd"</span>
<span class="token operator">></span><span class="token operator">&lt;</span>fs<span class="token operator">></span>  <span class="token builtin class-name">command</span> <span class="token string">"systemctl start httpd"</span>
<span class="token operator">></span><span class="token operator">&lt;</span>fs<span class="token operator">></span> <span class="token function">touch</span> /var/www/html/index.html
<span class="token operator">></span><span class="token operator">&lt;</span>fs<span class="token operator">></span> <span class="token function">vi</span> /var/www/html/index.html
<span class="token operator">></span><span class="token operator">&lt;</span>fs<span class="token operator">></span> <span class="token builtin class-name">command</span> <span class="token string">"useradd test"</span>
<span class="token operator">></span><span class="token operator">&lt;</span>fs<span class="token operator">></span> selinux-relabel /etc/selinux/targeted/contexts/files/file_contexts /
<span class="token operator">></span><span class="token operator">&lt;</span>fs<span class="token operator">></span> <span class="token builtin class-name">exit</span>
<span class="token punctuation">[</span>student@workstation ~<span class="token punctuation">(</span>developer1-finance<span class="token punctuation">)</span><span class="token punctuation">]</span>$ <span class="token builtin class-name">source</span> developer1-finance-rc 
<span class="token comment">#上传镜像</span>
<span class="token punctuation">[</span>student@workstation ~<span class="token punctuation">(</span>developer1-finance<span class="token punctuation">)</span><span class="token punctuation">]</span>$ openstack image create --disk-format qcow2 --min-disk <span class="token number">10</span> --min-ram <span class="token number">2048</span> --file ~/finance-rhel-db.qcow2 finance-rhel-db<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>发放云主机</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment">#发送云主机</span>
<span class="token punctuation">[</span>student@workstation ~<span class="token punctuation">(</span>developer1-finance<span class="token punctuation">)</span><span class="token punctuation">]</span>$ openstack server create --flavor default --key-name example-keypair --nic net-id<span class="token operator">=</span>finance-network1 --security-group finance-db --image finance-rhel-db --wait finance-db1
<span class="token comment">#绑定浮动ip</span>
<span class="token punctuation">[</span>student@workstation ~<span class="token punctuation">(</span>developer1-finance<span class="token punctuation">)</span><span class="token punctuation">]</span>$ openstack floating <span class="token function">ip</span> list
<span class="token punctuation">[</span>student@workstation ~<span class="token punctuation">(</span>developer1-finance<span class="token punctuation">)</span><span class="token punctuation">]</span>$ openstack server <span class="token function">add</span> floating <span class="token function">ip</span> finance-db1 <span class="token number">172.25</span>.250.110
<span class="token comment">#登录云主机</span>
<span class="token punctuation">[</span>student@workstation ~<span class="token punctuation">(</span>developer1-finance<span class="token punctuation">)</span><span class="token punctuation">]</span>$ <span class="token function">ssh</span> cloud-user@172.25.250.110
Warning: Permanently added <span class="token string">'172.25.250.110'</span> <span class="token punctuation">(</span>ECDSA<span class="token punctuation">)</span> to the list of known hosts.
<span class="token punctuation">[</span>cloud-user@finance-db1 ~<span class="token punctuation">]</span>$ 
<span class="token comment">#在安全组规则中放心80端口</span>
<span class="token punctuation">[</span>student@workstation ~<span class="token punctuation">(</span>developer1-finance<span class="token punctuation">)</span><span class="token punctuation">]</span>$ <span class="token function">curl</span> <span class="token number">172.25</span>.250.110<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>清除环境</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>student@workstation ~<span class="token punctuation">]</span>$ lab customization-img-customizing cleanup<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h3 id="第三节-部署期间初始化实例">第三节 部署期间初始化实例</h3>
<h4 id="练习：cloud-init自定义创建的实例">练习：cloud-init自定义创建的实例</h4>
<p>初始化环境</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>student@workstation ~<span class="token punctuation">]</span>$ lab customization-img-cloudinit setup<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>下载镜像</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>student@workstation ~<span class="token punctuation">(</span>developer1-finance<span class="token punctuation">)</span><span class="token punctuation">]</span>$ <span class="token function">wget</span> http://materials.example.com/osp-small.qcow2 -O ~/cloud-init<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>编辑镜像</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>student@workstation ~<span class="token punctuation">(</span>developer1-finance<span class="token punctuation">)</span><span class="token punctuation">]</span>$  <span class="token builtin class-name">source</span> developer1-finance-rc
<span class="token comment">#上传镜像</span>
<span class="token punctuation">[</span>student@workstation ~<span class="token punctuation">(</span>developer1-finance<span class="token punctuation">)</span><span class="token punctuation">]</span>$ openstack image create --disk-format qcow2 --min-disk <span class="token number">10</span> --min-ram <span class="token number">2048</span> --file cloud-init cloud-init
<span class="token comment">#发送云主机</span>
<span class="token punctuation">[</span>student@workstation ~<span class="token punctuation">(</span>developer1-finance<span class="token punctuation">)</span><span class="token punctuation">]</span>$ <span class="token function">vim</span> user-data
<span class="token comment">#!/bin/bash</span>
yum -y <span class="token function">install</span> httpd
systemctl <span class="token builtin class-name">enable</span> httpd
systemctl start httpd
<span class="token builtin class-name">echo</span> hello delbert <span class="token operator">></span> /var/www/html/index.html
<span class="token punctuation">[</span>student@workstation ~<span class="token punctuation">(</span>developer1-finance<span class="token punctuation">)</span><span class="token punctuation">]</span>$ openstack server create --flavor default --key-name example-keypair --nic net-id<span class="token operator">=</span>finance-network1 --security-group default --image cloud-init --user-data ~/user-data --wait cloud-init
<span class="token comment">#浮动ip</span>
<span class="token punctuation">[</span>student@workstation ~<span class="token punctuation">(</span>developer1-finance<span class="token punctuation">)</span><span class="token punctuation">]</span>$ openstack floating <span class="token function">ip</span> list
<span class="token punctuation">[</span>student@workstation ~<span class="token punctuation">(</span>developer1-finance<span class="token punctuation">)</span><span class="token punctuation">]</span>$ openstack server <span class="token function">add</span> floating <span class="token function">ip</span> cloud-init <span class="token number">172.25</span>.250.110
<span class="token comment">#登录云主机</span>
<span class="token punctuation">[</span>student@workstation ~<span class="token punctuation">(</span>developer1-finance<span class="token punctuation">)</span><span class="token punctuation">]</span>$ <span class="token function">ssh</span> cloud-user@172.25.250.110
<span class="token comment">#在安全组规则中放行80端口</span>
<span class="token punctuation">[</span>student@workstation ~<span class="token punctuation">(</span>developer1-finance<span class="token punctuation">)</span><span class="token punctuation">]</span>$ <span class="token function">curl</span> <span class="token number">172.25</span>.250.110<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>清除环境</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>student@workstation ~<span class="token punctuation">]</span>$ lab customization-img-cloudinit cleanup<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h2 id="第五章-存储管理">第五章 存储管理</h2>
<h3 id="第一节-实施块存储">第一节 实施块存储</h3>
<p>查看ceph节点的osd信息</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@ceph0 ~<span class="token punctuation">]</span><span class="token comment"># docker ps | grep osd</span>
e40a31cb9b3a        <span class="token number">172.25</span>.249.200:8787/rhceph/rhceph-3-rhel7:latest    <span class="token string">"/entrypoint.sh"</span>    <span class="token number">57</span> minutes ago      Up <span class="token number">57</span> minutes                           ceph-osd-ceph0-vdb
c99645015af3        <span class="token number">172.25</span>.249.200:8787/rhceph/rhceph-3-rhel7:latest    <span class="token string">"/entrypoint.sh"</span>    <span class="token number">57</span> minutes ago      Up <span class="token number">57</span> minutes                           ceph-osd-ceph0-vdd
89d4aa639ddf        <span class="token number">172.25</span>.249.200:8787/rhceph/rhceph-3-rhel7:latest    <span class="token string">"/entrypoint.sh"</span>    <span class="token number">57</span> minutes ago      Up <span class="token number">57</span> minutes                           ceph-osd-ceph0-vdc
<span class="token punctuation">[</span>root@ceph0 ~<span class="token punctuation">]</span><span class="token comment"># lsblk</span>
NAME   MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT
sr0     <span class="token number">11</span>:0    <span class="token number">1</span>  738K  <span class="token number">0</span> rom  
vda    <span class="token number">252</span>:0    <span class="token number">0</span>   40G  <span class="token number">0</span> disk 
├─vda1 <span class="token number">252</span>:1    <span class="token number">0</span>    1M  <span class="token number">0</span> part 
└─vda2 <span class="token number">252</span>:2    <span class="token number">0</span>   40G  <span class="token number">0</span> part /
vdb    <span class="token number">252</span>:16   <span class="token number">0</span>   20G  <span class="token number">0</span> disk 
├─vdb1 <span class="token number">252</span>:17   <span class="token number">0</span>   19G  <span class="token number">0</span> part 
└─vdb2 <span class="token number">252</span>:18   <span class="token number">0</span>    1G  <span class="token number">0</span> part <span class="token comment">#日志区：用于高速缓存</span>
vdc    <span class="token number">252</span>:32   <span class="token number">0</span>   20G  <span class="token number">0</span> disk 
├─vdc1 <span class="token number">252</span>:33   <span class="token number">0</span>   19G  <span class="token number">0</span> part 
└─vdc2 <span class="token number">252</span>:34   <span class="token number">0</span>    1G  <span class="token number">0</span> part <span class="token comment">#日志区：用于高速缓存</span>
vdd    <span class="token number">252</span>:48   <span class="token number">0</span>   20G  <span class="token number">0</span> disk 
├─vdd1 <span class="token number">252</span>:49   <span class="token number">0</span>   19G  <span class="token number">0</span> part 
└─vdd2 <span class="token number">252</span>:50   <span class="token number">0</span>    1G  <span class="token number">0</span> part <span class="token comment">#日志区：用于高速缓存</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>查看控制节点运行的ceph角色</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@controller0 ~<span class="token punctuation">]</span><span class="token comment"># docker ps | grep ceph</span>
764e05afea1c        <span class="token number">172.25</span>.249.200:8787/rhceph/rhceph-3-rhel7:latest                       <span class="token string">"/entrypoint.sh"</span>         <span class="token number">58</span> minutes ago      Up <span class="token number">58</span> minutes                                       ceph-mds-controller0
fc4f33fe63a0        <span class="token number">172.25</span>.249.200:8787/rhceph/rhceph-3-rhel7:latest                       <span class="token string">"/entrypoint.sh"</span>         <span class="token number">58</span> minutes ago      Up <span class="token number">58</span> minutes                                       ceph-mgr-controller0
25f52714cd63        <span class="token number">172.25</span>.249.200:8787/rhceph/rhceph-3-rhel7:latest                       <span class="token string">"/entrypoint.sh"</span>         <span class="token number">58</span> minutes ago      Up <span class="token number">58</span> minutes                                       ceph-mon-controller0<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>查看存储池</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@controller0 ~<span class="token punctuation">]</span><span class="token comment"># ceph osd pool ls</span>
images			<span class="token comment">#给glance提供存储</span>
metrics			<span class="token comment">#Ceilometer使用</span>
backups			<span class="token comment">#nova使用，虚拟机备份</span>
vms				<span class="token comment">#nova使用，虚拟机临时存储</span>
volumes			<span class="token comment">#给cinder提供块存储</span>
manila_data		<span class="token comment">#共享文件系统</span>
manila_metadata<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>查看镜像</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@controller0 ~<span class="token punctuation">]</span><span class="token comment"># rbd -p images ls</span>
14b7e8b2-7c6d-4bcf-b159-1e4e7582107c
1964be99-7551-4048-bbdd-5c2764231cde
5f7f8208-33b5-4f17-8297-588f938182c0
6b0128a9-4481-4ceb-b34e-ffe92e0dcfdd
ec9473de-4048-4ebb-b08a-a9be619477ac
<span class="token punctuation">[</span>student@workstation ~<span class="token punctuation">(</span>developer1-finance<span class="token punctuation">)</span><span class="token punctuation">]</span>$ openstack image list
+--------------------------------------+-----------------+--------+
<span class="token operator">|</span> ID                                   <span class="token operator">|</span> Name            <span class="token operator">|</span> Status <span class="token operator">|</span>
+--------------------------------------+-----------------+--------+
<span class="token operator">|</span> 1964be99-7551-4048-bbdd-5c2764231cde <span class="token operator">|</span> cloud-init      <span class="token operator">|</span> active <span class="token operator">|</span>
<span class="token operator">|</span> ec9473de-4048-4ebb-b08a-a9be619477ac <span class="token operator">|</span> octavia-amphora <span class="token operator">|</span> active <span class="token operator">|</span>
<span class="token operator">|</span> 6b0128a9-4481-4ceb-b34e-ffe92e0dcfdd <span class="token operator">|</span> rhel7           <span class="token operator">|</span> active <span class="token operator">|</span>
<span class="token operator">|</span> 5f7f8208-33b5-4f17-8297-588f938182c0 <span class="token operator">|</span> rhel7-db        <span class="token operator">|</span> active <span class="token operator">|</span>
<span class="token operator">|</span> 14b7e8b2-7c6d-4bcf-b159-1e4e7582107c <span class="token operator">|</span> rhel7-web       <span class="token operator">|</span> active <span class="token operator">|</span>
+--------------------------------------+-----------------+--------+<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>查看虚拟机</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@controller0 ~<span class="token punctuation">]</span><span class="token comment"># rbd -p vms ls</span>
6babf3b3-4d11-4572-ba78-b941b379ec38_disk
<span class="token punctuation">[</span>student@workstation ~<span class="token punctuation">(</span>developer1-finance<span class="token punctuation">)</span><span class="token punctuation">]</span>$ openstack server list
+--------------------------------------+------------+--------+----------------------------------------------+------------+---------+
<span class="token operator">|</span> ID                                   <span class="token operator">|</span> Name       <span class="token operator">|</span> Status <span class="token operator">|</span> Networks                                     <span class="token operator">|</span> Image      <span class="token operator">|</span> Flavor  <span class="token operator">|</span>
+--------------------------------------+------------+--------+----------------------------------------------+------------+---------+
<span class="token operator">|</span> 6babf3b3-4d11-4572-ba78-b941b379ec38 <span class="token operator">|</span> cloud-init <span class="token operator">|</span> ACTIVE <span class="token operator">|</span> finance-network1<span class="token operator">=</span><span class="token number">192.168</span>.1.9, <span class="token number">172.25</span>.250.110 <span class="token operator">|</span> cloud-init <span class="token operator">|</span> default <span class="token operator">|</span>
+--------------------------------------+------------+--------+----------------------------------------------+------------+---------+<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>rados命令查看对象</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@controller0 ~<span class="token punctuation">]</span><span class="token comment"># rados -p vms ls | head</span>
rbd_data.ae976b8b4567.00000000000003f8
rbd_data.ae976b8b4567.00000000000001f5
rbd_data.ae976b8b4567.0000000000000016
rbd_data.ae976b8b4567.0000000000000651
rbd_data.ae976b8b4567.000000000000064e
rbd_data.ae976b8b4567.000000000000023f
rbd_data.ae976b8b4567.00000000000005df
rbd_data.ae976b8b4567.0000000000000625
rbd_data.ae976b8b4567.00000000000005de
rbd_data.ae976b8b4567.0000000000000256<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>服务都是通过openstack用户访问ceph存储，查看openstack用户权限</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@controller0 ~<span class="token punctuation">]</span><span class="token comment"># ceph auth get client.openstack</span>
<span class="token punctuation">[</span>client.openstack<span class="token punctuation">]</span>
        key <span class="token operator">=</span> AQAPHM9bAAAAABAA8DLv19H7QXzX0CnaTql/1w<span class="token operator">==</span>
        caps mds <span class="token operator">=</span> <span class="token string">""</span>
        caps mgr <span class="token operator">=</span> <span class="token string">"allow *"</span>
        caps mon <span class="token operator">=</span> <span class="token string">"profile rbd"</span>
        caps osd <span class="token operator">=</span> <span class="token string">"profile rbd pool=volumes, profile rbd pool=backups, profile rbd pool=vms, profile rbd pool=images, profile rbd pool=metrics"</span>
exported keyring <span class="token keyword">for</span> client.openstack<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在控制节点查看cinder对接ceph的配置</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@controller0 ~<span class="token punctuation">]</span><span class="token comment"># vim /var/lib/config-data/puppet-generated/cinder/etc/cinder/cinder.conf </span>
<span class="token punctuation">[</span>tripleo_ceph<span class="token punctuation">]</span>
<span class="token assign-left variable">backend_host</span><span class="token operator">=</span>hostgroup
<span class="token assign-left variable">volume_backend_name</span><span class="token operator">=</span>tripleo_ceph
<span class="token assign-left variable">volume_driver</span><span class="token operator">=</span>cinder.volume.drivers.rbd.RBDDriver
<span class="token assign-left variable">rbd_ceph_conf</span><span class="token operator">=</span>/etc/ceph/ceph.conf
<span class="token assign-left variable">rbd_user</span><span class="token operator">=</span>openstack
<span class="token assign-left variable">rbd_pool</span><span class="token operator">=</span>volumes<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在控制节点查看glance对接ceph的配置</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@controller0 ~<span class="token punctuation">]</span><span class="token comment"># vim /var/lib/config-data/puppet-generated/glance_api/etc/glance/glance-api.conf </span>
<span class="token punctuation">[</span>glance_store<span class="token punctuation">]</span>
<span class="token assign-left variable">stores</span><span class="token operator">=</span>http,rbd
<span class="token assign-left variable">default_store</span><span class="token operator">=</span>rbd
<span class="token assign-left variable">rbd_store_pool</span><span class="token operator">=</span>images
<span class="token assign-left variable">rbd_store_user</span><span class="token operator">=</span>openstack
<span class="token assign-left variable">rbd_store_ceph_conf</span><span class="token operator">=</span>/etc/ceph/ceph.conf
<span class="token assign-left variable">os_region_name</span><span class="token operator">=</span>regionOne<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在计算节点查看nova对接ceph的配置</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@compute0 ~<span class="token punctuation">]</span><span class="token comment"># vim /var/lib/config-data/puppet-generated/nova_libvirt/etc/nova/nova.conf</span>
<span class="token punctuation">[</span>libvirt<span class="token punctuation">]</span>
<span class="token assign-left variable">live_migration_uri</span><span class="token operator">=</span>qemu+ssh://nova_migration@%s:2022/system?keyfile<span class="token operator">=</span>/etc/nova/migration/identity
<span class="token assign-left variable">rbd_user</span><span class="token operator">=</span>openstack
<span class="token assign-left variable">rbd_secret_uuid</span><span class="token operator">=</span>fe8e3db0-d6c3-11e8-a76d-52540001fac8
<span class="token assign-left variable">images_type</span><span class="token operator">=</span>rbd
<span class="token assign-left variable">images_rbd_pool</span><span class="token operator">=</span>vms
<span class="token assign-left variable">images_rbd_ceph_conf</span><span class="token operator">=</span>/etc/ceph/ceph.conf
<span class="token assign-left variable">virt_type</span><span class="token operator">=</span>kvm
<span class="token assign-left variable">cpu_mode</span><span class="token operator">=</span>none
<span class="token assign-left variable">inject_password</span><span class="token operator">=</span>False
<span class="token assign-left variable">inject_key</span><span class="token operator">=</span>False
<span class="token assign-left variable">inject_partition</span><span class="token operator">=</span>-2
<span class="token assign-left variable">hw_disk_discard</span><span class="token operator">=</span>unmap
<span class="token assign-left variable">enabled_perf_events</span><span class="token operator">=</span>
<span class="token assign-left variable">disk_cachemodes</span><span class="token operator">=</span>network<span class="token operator">=</span>writeback
<span class="token comment">#libvirt与ceph对接组要密钥</span>
<span class="token punctuation">[</span>root@compute0 ~<span class="token punctuation">]</span><span class="token comment"># virsh secret-list</span>
 UUID                                  Usage
--------------------------------------------------------------------------------
 fe8e3db0-d6c3-11e8-a76d-52540001fac8  ceph client.openstack secret<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="练习：管理cinder块存储">练习：管理cinder块存储</h4>
<p>准备环境</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>student@workstation ~<span class="token punctuation">]</span>$ lab storage-backend setup<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>查看ceph集群状态</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>student@workstation ~<span class="token punctuation">]</span>$ <span class="token function">ssh</span> root@controller0
<span class="token punctuation">[</span>root@controller0 ~<span class="token punctuation">]</span><span class="token comment">#  docker ps | grep ceph</span>
764e05afea1c        <span class="token number">172.25</span>.249.200:8787/rhceph/rhceph-3-rhel7:latest                       <span class="token string">"/entrypoint.sh"</span>         About an hour ago   Up About an hour                                     ceph-mds-controller0
fc4f33fe63a0        <span class="token number">172.25</span>.249.200:8787/rhceph/rhceph-3-rhel7:latest                       <span class="token string">"/entrypoint.sh"</span>         About an hour ago   Up About an hour                                     ceph-mgr-controller0
25f52714cd63        <span class="token number">172.25</span>.249.200:8787/rhceph/rhceph-3-rhel7:latest                       <span class="token string">"/entrypoint.sh"</span>         About an hour ago   Up About an hour                                     ceph-mon-controller0
<span class="token punctuation">[</span>root@controller0 ~<span class="token punctuation">]</span><span class="token comment"># ceph -s</span>
  cluster:
    id:     fe8e3db0-d6c3-11e8-a76d-52540001fac8
    health: HEALTH_OK
 
  services:
    mon: <span class="token number">1</span> daemons, quorum controller0
    mgr: controller0<span class="token punctuation">(</span>active<span class="token punctuation">)</span>
    mds: cephfs-1/1/1 up  <span class="token punctuation">&#123;</span><span class="token number">0</span><span class="token operator">=</span>controller0<span class="token operator">=</span>up:active<span class="token punctuation">&#125;</span>
    osd: <span class="token number">6</span> osds: <span class="token number">6</span> up, <span class="token number">6</span> <span class="token keyword">in</span>
 
  data:
    pools:   <span class="token number">7</span> pools, <span class="token number">416</span> pgs
    objects: <span class="token number">1434</span> objects, <span class="token number">9120</span> MB
    usage:   <span class="token number">9759</span> MB used, <span class="token number">104</span> GB / <span class="token number">113</span> GB avail
    pgs:     <span class="token number">416</span> active+clean
 
  io:
    client:   <span class="token number">3155</span> B/s wr, <span class="token number">0</span> op/s rd, <span class="token number">0</span> op/s wr
 
<span class="token punctuation">[</span>root@controller0 ~<span class="token punctuation">]</span><span class="token comment"># docker exec -it glance_api grep -iE 'rbd|ceph' /etc/glance/glance-api.conf | grep -v ^# | grep -v ^$</span>
<span class="token assign-left variable">stores</span><span class="token operator">=</span>http,rbd
<span class="token assign-left variable">default_store</span><span class="token operator">=</span>rbd
<span class="token assign-left variable">rbd_store_pool</span><span class="token operator">=</span>images
<span class="token assign-left variable">rbd_store_user</span><span class="token operator">=</span>openstack
<span class="token assign-left variable">rbd_store_ceph_conf</span><span class="token operator">=</span>/etc/ceph/ceph.conf
<span class="token punctuation">[</span>root@controller0 ~<span class="token punctuation">]</span><span class="token comment"># docker exec -it cinder_api grep -Ei 'rbd|ceph' /etc/cinder/cinder.conf | grep -v ^#</span>
<span class="token assign-left variable">enabled_backends</span><span class="token operator">=</span>tripleo_ceph
<span class="token punctuation">[</span>tripleo_ceph<span class="token punctuation">]</span>
<span class="token assign-left variable">volume_backend_name</span><span class="token operator">=</span>tripleo_ceph
<span class="token assign-left variable">volume_driver</span><span class="token operator">=</span>cinder.volume.drivers.rbd.RBDDriver
<span class="token assign-left variable">rbd_ceph_conf</span><span class="token operator">=</span>/etc/ceph/ceph.conf
<span class="token assign-left variable">rbd_user</span><span class="token operator">=</span>openstack
<span class="token assign-left variable">rbd_pool</span><span class="token operator">=</span>volumes
<span class="token punctuation">[</span>root@controller0 ~<span class="token punctuation">]</span><span class="token comment"># ceph osd pool ls</span>
images
metrics
backups
vms
volumes
manila_data
manila_metadata
<span class="token punctuation">[</span>root@controller0 ~<span class="token punctuation">]</span><span class="token comment"># exit</span>
<span class="token builtin class-name">logout</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>上传镜像到ceph存储</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>student@workstation ~<span class="token punctuation">]</span>$ <span class="token builtin class-name">source</span> developer1-finance-rc
<span class="token punctuation">[</span>student@workstation ~<span class="token punctuation">(</span>developer1-finance<span class="token punctuation">)</span><span class="token punctuation">]</span>$ <span class="token function">wget</span> http://materials.example.com/osp-small.qcow2
<span class="token punctuation">[</span>student@workstation ~<span class="token punctuation">(</span>developer1-finance<span class="token punctuation">)</span><span class="token punctuation">]</span>$ openstack image create --disk-format qcow2 --file ~/osp-small.qcow2 finance-image
<span class="token punctuation">[</span>student@workstation ~<span class="token punctuation">(</span>developer1-finance<span class="token punctuation">)</span><span class="token punctuation">]</span>$ openstack image list
+--------------------------------------+-----------------+--------+
<span class="token operator">|</span> ID                                   <span class="token operator">|</span> Name            <span class="token operator">|</span> Status <span class="token operator">|</span>
+--------------------------------------+-----------------+--------+
<span class="token operator">|</span> 1964be99-7551-4048-bbdd-5c2764231cde <span class="token operator">|</span> cloud-init      <span class="token operator">|</span> active <span class="token operator">|</span>
<span class="token operator">|</span> cd3027b1-7fdb-4ce2-999a-200259350fe1 <span class="token operator">|</span> finance-image   <span class="token operator">|</span> active <span class="token operator">|</span>
<span class="token operator">|</span> ec9473de-4048-4ebb-b08a-a9be619477ac <span class="token operator">|</span> octavia-amphora <span class="token operator">|</span> active <span class="token operator">|</span>
<span class="token operator">|</span> 6b0128a9-4481-4ceb-b34e-ffe92e0dcfdd <span class="token operator">|</span> rhel7           <span class="token operator">|</span> active <span class="token operator">|</span>
<span class="token operator">|</span> 5f7f8208-33b5-4f17-8297-588f938182c0 <span class="token operator">|</span> rhel7-db        <span class="token operator">|</span> active <span class="token operator">|</span>
<span class="token operator">|</span> 14b7e8b2-7c6d-4bcf-b159-1e4e7582107c <span class="token operator">|</span> rhel7-web       <span class="token operator">|</span> active <span class="token operator">|</span>
+--------------------------------------+-----------------+--------+
<span class="token punctuation">[</span>root@controller0 ~<span class="token punctuation">]</span><span class="token comment"># rados -p image ls | grep cd3027b1-7fdb-4ce2-999a-200259350fe1</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>创建云主机和云硬盘，并将云硬盘挂在给云主机</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>student@workstation ~<span class="token punctuation">(</span>developer1-finance<span class="token punctuation">)</span><span class="token punctuation">]</span>$ openstack server create --flavor default --image finance-image --nic net-id<span class="token operator">=</span>finance-network1 --security-group default finance-server1
<span class="token punctuation">[</span>student@workstation ~<span class="token punctuation">(</span>developer1-finance<span class="token punctuation">)</span><span class="token punctuation">]</span>$ openstack server list
<span class="token punctuation">[</span>student@workstation ~<span class="token punctuation">(</span>developer1-finance<span class="token punctuation">)</span><span class="token punctuation">]</span>$ openstack volume create --size <span class="token number">1</span> finance-volume1
<span class="token punctuation">[</span>student@workstation ~<span class="token punctuation">(</span>developer1-finance<span class="token punctuation">)</span><span class="token punctuation">]</span>$ openstack volume list
<span class="token punctuation">[</span>student@workstation ~<span class="token punctuation">(</span>developer1-finance<span class="token punctuation">)</span><span class="token punctuation">]</span>$ openstack server <span class="token function">add</span> volume finance-server1 finance-volume1
<span class="token punctuation">[</span>student@workstation ~<span class="token punctuation">(</span>developer1-finance<span class="token punctuation">)</span><span class="token punctuation">]</span>$ openstack volume list
+--------------------------------------+-----------------+--------+------+------------------------------------------+
<span class="token operator">|</span> ID                                   <span class="token operator">|</span> Name            <span class="token operator">|</span> Status <span class="token operator">|</span> Size <span class="token operator">|</span> Attached to                              <span class="token operator">|</span>
+--------------------------------------+-----------------+--------+------+------------------------------------------+
<span class="token operator">|</span> 7caf5e6a-b7a1-4e0b-b63f-9d5000f02f7e <span class="token operator">|</span> finance-volume1 <span class="token operator">|</span> in-use <span class="token operator">|</span>    <span class="token number">1</span> <span class="token operator">|</span> Attached to finance-server1 on /dev/vdb  <span class="token operator">|</span>
+--------------------------------------+-----------------+--------+------+------------------------------------------+
<span class="token punctuation">[</span>root@controller0 ~<span class="token punctuation">]</span><span class="token comment"># rados -p volumes ls</span>
rbd_directory
rbd_info
rbd_header.b0d02b94f43e
rbd_id.volume-7caf5e6a-b7a1-4e0b-b63f-9d5000f02f7e
rbd_object_map.b0d02b94f43e<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>清除环境</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>student@workstation ~<span class="token punctuation">]</span>$ lab storage-backend cleanup<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h3 id="第二节-比较块存储">第二节 比较块存储</h3>
<p>swift命令：</p>
<p>老版本 OpenStack 中的 swift post、swift list 和 swift stat 等命令仍然支持</p>
<p>新版本 OpenStack 中，使用 OpenStack 统一命令行工具管理</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ openstack container create <span class="token operator">&lt;</span>container_name<span class="token operator">></span>：创建容器
$ openstack container list：列出所有可用的容器
$ openstack container delete <span class="token operator">&lt;</span>container_name<span class="token operator">></span>：删除指定的容器
$ openstack container save <span class="token operator">&lt;</span>container_name<span class="token operator">></span>：下载/保存指定容器中的内容至本地
$ openstack object create <span class="token operator">&lt;</span>container_name<span class="token operator">></span> <span class="token operator">&lt;</span>object_name<span class="token operator">></span>：上传已存在的对象至指定容器中
$ openstack object list <span class="token operator">&lt;</span>container_name<span class="token operator">></span>：列出指定容器中的所有对象
$ openstack object delete <span class="token operator">&lt;</span>container_name<span class="token operator">></span> <span class="token operator">&lt;</span>object_name<span class="token operator">></span>：删除指定容器中的对象<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="第三节-manila共享文件系统">第三节 manila共享文件系统</h3>
<p>以管理员用户身份创建共享类型</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ manila type-create cephfstype <span class="token boolean">false</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>说明：false 参数为 driver_handles_share_servers 参数的值，若开启动态扩展共享节点，该参数为 true</p>
<p>以租户用户身份创建共享</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ manila create --name demo-share --share-type cephfstype cephfs <span class="token number">1</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>说明： --share-type 选项基于后端存储对共享进行分类，并且该共享大小为1GB。 当共享可用时，启动虚拟机实例，单独连接 tenant 网络和存储网络（租户网络与存储网络需要隔离）</p>
<p>在 Ceph Monitor 节点上以 client.manila 用户进行身份认证来创建 cephx 用户，保存该用户的 secret key</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ ceph --name<span class="token operator">=</span>client.manila --keyring<span class="token operator">=</span>/etc/ceph/manila.keyring auth get-orcreata client.cloud-user <span class="token operator">></span> cloud-user.keyring
$ manila access-allow demo-share cephx cloud-user<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>追踪共享的导出路径</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ manila share-export-location-list demo-share --columns Path<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h4 id="练习：管理manila共享文件系统">练习：管理manila共享文件系统</h4>
<p>初始化环境</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>student@workstation ~<span class="token punctuation">]</span>$ lab storage-manila setup<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>登录控制节点，确保manila服务运行</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@controller0 ~<span class="token punctuation">]</span><span class="token comment"># docker ps | grep manila</span>
86d61ab757fc        <span class="token number">172.25</span>.249.200:8787/rhosp13/openstack-manila-share:pcmklatest          <span class="token string">"/bin/bash /usr/lo..."</span>   About an hour ago   Up About an hour                                     openstack-manila-share-docker-0
f47af1e5d0c0        <span class="token number">172.25</span>.249.200:8787/rhosp13/openstack-manila-api:latest                <span class="token string">"kolla_start"</span>            <span class="token number">19</span> months ago       Up About an hour                                     manila_api
d601bacac004        <span class="token number">172.25</span>.249.200:8787/rhosp13/openstack-manila-scheduler:latest          <span class="token string">"kolla_start"</span>            <span class="token number">19</span> months ago       Up About an hour <span class="token punctuation">(</span>healthy<span class="token punctuation">)</span>                           manila_scheduler
You have mail <span class="token keyword">in</span> /var/spool/mail/root<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>查看manila对接ceph的配置</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@controller0 manila<span class="token punctuation">]</span><span class="token comment"># vim /var/lib/config-data/puppetgenerated/manila/etc/manila/manila.conf</span>
<span class="token assign-left variable">enabled_share_backends</span><span class="token operator">=</span>cephfs
<span class="token assign-left variable">enabled_share_protocols</span><span class="token operator">=</span>CEPHFS
<span class="token punctuation">[</span>cephfs<span class="token punctuation">]</span>
<span class="token assign-left variable">driver_handles_share_servers</span><span class="token operator">=</span>False
<span class="token assign-left variable">share_backend_name</span><span class="token operator">=</span>cephfs
<span class="token assign-left variable">share_driver</span><span class="token operator">=</span>manila.share.drivers.cephfs.driver.CephFSDriver
<span class="token assign-left variable">cephfs_conf_path</span><span class="token operator">=</span>/etc/ceph/ceph.conf
<span class="token assign-left variable">cephfs_auth_id</span><span class="token operator">=</span>manila
<span class="token assign-left variable">cephfs_cluster_name</span><span class="token operator">=</span>ceph
<span class="token assign-left variable">cephfs_enable_snapshots</span><span class="token operator">=</span>False
<span class="token assign-left variable">cephfs_protocol_helper_type</span><span class="token operator">=</span>CEPHFS
<span class="token punctuation">[</span>root@controller0 manila<span class="token punctuation">]</span><span class="token comment"># exit</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>创建manila共享文件系统，并发放云主机</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>student@workstation ~<span class="token punctuation">(</span>developer1-finance<span class="token punctuation">)</span><span class="token punctuation">]</span>$ <span class="token function">cat</span> manila/user-data.file 
<span class="token comment">#!/bin/bash</span>
<span class="token function">cat</span> <span class="token operator">></span> /etc/sysconfig/network-scripts/ifcfg-eth1 <span class="token operator">&lt;&lt;</span> <span class="token string">eof
DEVICE=eth1
ONBOOT=yes
BOOTPROTO=dhcp
eof</span>
<span class="token function">ifup</span> eth1
<span class="token punctuation">[</span>student@workstation ~<span class="token punctuation">]</span>$ <span class="token builtin class-name">source</span> architect1-finance-rc 
<span class="token punctuation">[</span>student@workstation ~<span class="token punctuation">(</span>architect1-finance<span class="token punctuation">)</span><span class="token punctuation">]</span>$ manila service-list
+----+------------------+------------------+------+---------+-------+----------------------------+
<span class="token operator">|</span> Id <span class="token operator">|</span> Binary           <span class="token operator">|</span> Host             <span class="token operator">|</span> Zone <span class="token operator">|</span> Status  <span class="token operator">|</span> State <span class="token operator">|</span> Updated_at                 <span class="token operator">|</span>
+----+------------------+------------------+------+---------+-------+----------------------------+
<span class="token operator">|</span> <span class="token number">1</span>  <span class="token operator">|</span> manila-scheduler <span class="token operator">|</span> hostgroup        <span class="token operator">|</span> nova <span class="token operator">|</span> enabled <span class="token operator">|</span> up    <span class="token operator">|</span> <span class="token number">2020</span>-05-31T17:57:18.000000 <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2</span>  <span class="token operator">|</span> manila-share     <span class="token operator">|</span> hostgroup@cephfs <span class="token operator">|</span> nova <span class="token operator">|</span> enabled <span class="token operator">|</span> up    <span class="token operator">|</span> <span class="token number">2020</span>-05-31T17:57:21.000000 <span class="token operator">|</span>
+----+------------------+------------------+------+---------+-------+----------------------------+
<span class="token punctuation">[</span>student@workstation ~<span class="token punctuation">(</span>architect1-finance<span class="token punctuation">)</span><span class="token punctuation">]</span>$ manila type-create cephfstype <span class="token boolean">false</span>
<span class="token punctuation">[</span>student@workstation ~<span class="token punctuation">(</span>architect1-finance<span class="token punctuation">)</span><span class="token punctuation">]</span>$ <span class="token builtin class-name">source</span> developer1-finance-rc 
<span class="token punctuation">[</span>student@workstation ~<span class="token punctuation">(</span>developer1-finance<span class="token punctuation">)</span><span class="token punctuation">]</span>$ manila create --name finance-share1 --share-type cephfstype cephfs <span class="token number">1</span>
<span class="token punctuation">[</span>student@workstation ~<span class="token punctuation">(</span>developer1-finance<span class="token punctuation">)</span><span class="token punctuation">]</span>$ manila list
+--------------------------------------+----------------+------+-------------+-----------+-----------+-----------------+------+-------------------+
<span class="token operator">|</span> ID                                   <span class="token operator">|</span> Name           <span class="token operator">|</span> Size <span class="token operator">|</span> Share Proto <span class="token operator">|</span> Status    <span class="token operator">|</span> Is Public <span class="token operator">|</span> Share Type Name <span class="token operator">|</span> Host <span class="token operator">|</span> Availability Zone <span class="token operator">|</span>
+--------------------------------------+----------------+------+-------------+-----------+-----------+-----------------+------+-------------------+
<span class="token operator">|</span> fc5d9631-71a8-4a27-9a85-b7f0f93e7708 <span class="token operator">|</span> finance-share1 <span class="token operator">|</span> <span class="token number">1</span>    <span class="token operator">|</span> CEPHFS      <span class="token operator">|</span> available <span class="token operator">|</span> False     <span class="token operator">|</span> cephfstype      <span class="token operator">|</span>      <span class="token operator">|</span> nova              <span class="token operator">|</span>
+--------------------------------------+----------------+------+-------------+-----------+-----------+-----------------+------+-------------------+
<span class="token punctuation">[</span>student@workstation ~<span class="token punctuation">(</span>developer1-finance<span class="token punctuation">)</span><span class="token punctuation">]</span>$ openstack server create --flavor default --image rhel7 --key-name example-keypair --nic net-id<span class="token operator">=</span>finance-network1 --nic net-id<span class="token operator">=</span>provider-storage --user-data /home/student/manila/user-data.file  finance-server1 --wait
<span class="token comment">#cloud=init 实现</span>
<span class="token punctuation">[</span>student@workstation ~<span class="token punctuation">(</span>developer1-finance<span class="token punctuation">)</span><span class="token punctuation">]</span>$ <span class="token function">cat</span> manila/user-data.file 
<span class="token comment">#!/bin/bash</span>
<span class="token function">cat</span> <span class="token operator">></span> /etc/sysconfig/network-scripts/ifcfg-eth1 <span class="token operator">&lt;&lt;</span> <span class="token string">eof
DEVICE=eth1
ONBOOT=yes
BOOTPROTO=dhcp
eof</span>
<span class="token function">ifup</span> eth1
<span class="token comment">#给云主机绑定浮动ip</span>
<span class="token punctuation">[</span>student@workstation ~<span class="token punctuation">(</span>developer1-finance<span class="token punctuation">)</span><span class="token punctuation">]</span>$ openstack server <span class="token function">add</span> floating <span class="token function">ip</span> finance-server1 <span class="token number">172.25</span>.250.102<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>用manila用户在ceph中创建cloud-user用户，用于访问ceph存储</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@controller0 ~<span class="token punctuation">]</span><span class="token comment"># ceph auth get-or-create client.cloud-user --name=client.manila --keyring=/etc/ceph/ceph.client.manila.keyring > /root/cloud-user.keyring</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>复制ceph配置文件和cloud-user的密钥到云主机中</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@controller0 ~<span class="token punctuation">]</span><span class="token comment"># scp cloud-user.keyring /etc/ceph/ceph.conf student@workstation:~</span>
<span class="token punctuation">[</span>student@workstation ~<span class="token punctuation">(</span>developer1-finance<span class="token punctuation">)</span><span class="token punctuation">]</span>$ <span class="token function">scp</span> ceph.conf cloud-user.keyring cloud-user@172.25.250.102:~<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>设置cloud-user用户可以访问manila共享文件系统</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>student@workstation ~<span class="token punctuation">(</span>developer1-finance<span class="token punctuation">)</span><span class="token punctuation">]</span>$  manila access-allow finance-share1 cephx cloud-user
<span class="token punctuation">[</span>student@workstation ~<span class="token punctuation">(</span>developer1-finance<span class="token punctuation">)</span><span class="token punctuation">]</span>$  manila access-list finance-share1 
+--------------------------------------+-------------+------------+--------------+--------+------------------------------------------+----------------------------+----------------------------+
<span class="token operator">|</span> <span class="token function">id</span>                                   <span class="token operator">|</span> access_type <span class="token operator">|</span> access_to  <span class="token operator">|</span> access_level <span class="token operator">|</span> state  <span class="token operator">|</span> access_key                               <span class="token operator">|</span> created_at                 <span class="token operator">|</span> updated_at                 <span class="token operator">|</span>
+--------------------------------------+-------------+------------+--------------+--------+------------------------------------------+----------------------------+----------------------------+
<span class="token operator">|</span> 2e6ae095-1385-4627-9cf6-d1fa207f77b9 <span class="token operator">|</span> cephx       <span class="token operator">|</span> cloud-user <span class="token operator">|</span> rw           <span class="token operator">|</span> active <span class="token operator">|</span> <span class="token assign-left variable">AQB58dNegxrMNhAA0rYfY6OtkvRhNcrbetTAjA</span><span class="token operator">==</span> <span class="token operator">|</span> <span class="token number">2020</span>-05-31T18:14:50.000000 <span class="token operator">|</span> <span class="token number">2020</span>-05-31T18:14:50.000000 <span class="token operator">|</span>
+--------------------------------------+-------------+------------+--------------+--------+------------------------------------------+----------------------------+----------------------------+<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>查看manila共享文件系统</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>student@workstation ~<span class="token punctuation">(</span>developer1-finance<span class="token punctuation">)</span><span class="token punctuation">]</span>$ manila share-export-location-list finance-share1
+--------------------------------------+------------------------------------------------------------------------+-----------+
<span class="token operator">|</span> ID                                   <span class="token operator">|</span> Path                                                                   <span class="token operator">|</span> Preferred <span class="token operator">|</span>
+--------------------------------------+------------------------------------------------------------------------+-----------+
<span class="token operator">|</span> 2d553e5a-f992-477c-93e3-908ee461ff42 <span class="token operator">|</span> <span class="token number">172.24</span>.3.1:6789:/volumes/_nogroup/7b7469ee-091a-4ad0-9c48-904ac9b74d2c <span class="token operator">|</span> False     <span class="token operator">|</span>
+--------------------------------------+------------------------------------------------------------------------+-----------+<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>登录云主机，安装驱动程序，挂载manila服务</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>student@workstation ~<span class="token punctuation">(</span>developer1-finance<span class="token punctuation">)</span><span class="token punctuation">]</span>$ <span class="token function">ssh</span> cloud-user@172.25.250.102
<span class="token punctuation">[</span>cloud-user@finance-server1 ~<span class="token punctuation">]</span>$ <span class="token function">su</span> -
Password: redhat
<span class="token punctuation">[</span>root@finance-server1 ~<span class="token punctuation">]</span><span class="token comment"># mkdir /mnt/ceph</span>
<span class="token punctuation">[</span>root@finance-server1 ~<span class="token punctuation">]</span><span class="token comment"># curl -s -f -o /etc/yum.repos.d/ceph.repo http://materials.example.com/ceph.repo</span>
<span class="token punctuation">[</span>root@finance-server1 ~<span class="token punctuation">]</span><span class="token comment"># yum -y install ceph-fuse</span>
<span class="token punctuation">[</span>root@finance-server1 ~<span class="token punctuation">]</span><span class="token comment"># mkdir -p /mnt/ceph</span>
<span class="token punctuation">[</span>root@finance-server1 ~<span class="token punctuation">]</span><span class="token comment"># ceph-fuse /mnt/ceph/ --id=cloud-user --conf=/home/cloud-user/ceph.conf --keyring=/home/cloud-user/cloud-user.keyring --client-mountpoint=/volumes/_nogroup/7b7469ee-091a-4ad0-9c48-904ac9b74d2c</span>
<span class="token punctuation">[</span>root@finance-server1 ~<span class="token punctuation">]</span><span class="token comment"># df -h /mnt/ceph</span>
Filesystem      Size  Used Avail Use% Mounted on
ceph-fuse       <span class="token number">1</span>.0G     <span class="token number">0</span>  <span class="token number">1</span>.0G   <span class="token number">0</span>% /mnt/ceph
<span class="token punctuation">[</span>root@finance-server1 ~<span class="token punctuation">]</span><span class="token comment"># echo hello > /mnt/ceph/hello.txt</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<img src="/2022/06/05/RHOSP13%E5%AE%9E%E9%AA%8C%E6%89%8B%E5%86%8C/20220626151835.png" class title="挂载点路径">
<p>清空环境</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>student@workstation ~<span class="token punctuation">(</span>developer1-finance<span class="token punctuation">)</span><span class="token punctuation">]</span>$ openstack server delete finance-server1
<span class="token punctuation">[</span>student@workstation ~<span class="token punctuation">(</span>developer1-finance<span class="token punctuation">)</span><span class="token punctuation">]</span>$ manila delete finance-share1
<span class="token punctuation">[</span>student@workstation ~<span class="token punctuation">(</span>developer1-finance<span class="token punctuation">)</span><span class="token punctuation">]</span>$ <span class="token builtin class-name">source</span> architect1-finance-rc 
<span class="token punctuation">[</span>student@workstation ~<span class="token punctuation">(</span>architect1-finance<span class="token punctuation">)</span><span class="token punctuation">]</span>$ manila type-delete cephfstype
<span class="token punctuation">[</span>student@workstation ~<span class="token punctuation">(</span>architect1-finance<span class="token punctuation">)</span><span class="token punctuation">]</span>$ lab storage-manila cleanup<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="第四节-管理临时存储">第四节 管理临时存储</h3>
<p><strong>临时与持久存储的区别</strong></p>
<ul>
<li>
<p>当租户用户使用镜像创建实例时，该实例具有的唯一的初始存储是临时存储（根磁盘）</p>
<p>该临时存储是一种非常简单且易用的存储资源，但缺乏存储分层（tiering）和磁盘容量扩展等高级功能</p>
</li>
<li>
<p>存储在临时存储中的任何数据在实例终止后无法保留</p>
</li>
<li>
<p>临时存储的生命周期由 OpenStack Nova 计算服务管理</p>
</li>
<li>
<p>持久存储在其附加的实例终止之后依然存在</p>
</li>
<li>
<p>持久存储由 OpenStack Cinder、Swift 与 Manila 管理</p>
</li>
</ul>
<p><strong>临时存储与 Libvirt：</strong></p>
<ul>
<li>Nova 计算服务使用 KVM 作为 Hypervisor 的原生 libvirt 虚拟化平台</li>
<li>实例作为 KVM 虚拟机存在，libvirtd 服务根据用户的指令对虚拟机执行操作</li>
<li>flavor 决定每个实例的大小</li>
<li>Nova 允许实例消耗来自 hypervisor 系统的计算和存储资源</li>
<li>flavor 属性还包括 vCPU数量、内存量、交换内存量、实例的磁盘大小，以及实例的额外临时磁盘大小</li>
<li>作为 flavor 定义的一部分而创建的存储单元本质上都是临时存储</li>
<li>默认情况下，计算服务在计算节点上的 /var/lib/nova/instances/UUID/ 目录中创建代表临时存储文件</li>
<li>若 Ceph 用作 Nova 的后端存储，则后端对象存储在通常名为 vms 的 pool 中</li>
<li>请注意，将 Ceph 存储用作 OpenStack 计算服务的后端存储并不使临时存储转换为持久存储！</li>
<li>临时存储仍然会在实例删除时消失，无论它位于计算节点本地，还是来自 Ceph等外部后端存储</li>
</ul>
<p><strong>创建持久根磁盘（Root Disks）：</strong></p>
<ul>
<li>
<p>实例镜像的内容可以提取到持久卷</p>
</li>
<li>
<p>通过任何实例对根文件系统所做的任何更改都将一直存在，直到删除持久卷为止</p>
<p>$ openstack volume create --size   &lt;volume_size&gt; --image &lt;image_name&gt; &lt;volume_name&gt;</p>
<p>例：$ openstack volume create --size 10 --image rhel7 demo-vol</p>
</li>
<li>
<p>创建名称为 demo-vol 的 volume，大小10GB，并将 rhel7 镜像根文件系统注入该 volume 中；使用 openstack server create 创建实例时，–volume 选项指定 volume 来启动实例</p>
</li>
</ul>
<h4 id="练习：管理临时存储">练习：管理临时存储</h4>
<p>准备环境</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>student@workstation ~<span class="token punctuation">(</span>architect1-finance<span class="token punctuation">)</span><span class="token punctuation">]</span>$ lab storage-compare setup<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>创建云主机</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>student@workstation ~<span class="token punctuation">]</span>$ <span class="token builtin class-name">source</span> architect1-finance-rc 
<span class="token punctuation">[</span>student@workstation ~<span class="token punctuation">(</span>architect1-finance<span class="token punctuation">)</span><span class="token punctuation">]</span>$ openstack server create --flavor default --image rhel7 --nic net-id<span class="token operator">=</span>finance-network1 --availability-zone nova:compute1.overcloud.example.com finance-server1
<span class="token punctuation">[</span>student@workstation ~<span class="token punctuation">(</span>architect1-finance<span class="token punctuation">)</span><span class="token punctuation">]</span>$ openstack server list
<span class="token punctuation">[</span>student@workstation ~<span class="token punctuation">(</span>architect1-finance<span class="token punctuation">)</span><span class="token punctuation">]</span>$ <span class="token function">ssh</span> root@controller0
Last login: Sun May <span class="token number">31</span> <span class="token number">17</span>:17:46 <span class="token number">2020</span> from <span class="token number">172.25</span>.250.254
<span class="token punctuation">[</span>root@controller0 ~<span class="token punctuation">]</span><span class="token comment"># rados -p vms ls | grep 3dda1087-d6b8-4e5d-ad49-2dd6c055c225</span>
rbd_id.3dda1087-d6b8-4e5d-ad49-2dd6c055c225_disk<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>删除云主机后，临时存储也被删除</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>student@workstation ~<span class="token punctuation">(</span>architect1-finance<span class="token punctuation">)</span><span class="token punctuation">]</span>$ openstack server delete finance-server1
<span class="token punctuation">[</span>student@workstation ~<span class="token punctuation">(</span>architect1-finance<span class="token punctuation">)</span><span class="token punctuation">]</span>$ <span class="token function">ssh</span> root@controller0
Last login: Sun May <span class="token number">31</span> <span class="token number">18</span>:58:25 <span class="token number">2020</span> from <span class="token number">172.25</span>.250.254
<span class="token punctuation">[</span>root@controller0 ~<span class="token punctuation">]</span><span class="token comment"># rados -p vms ls | grep 3dda1087-d6b8-4e5d-ad49-2dd6c055c225</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>设置临时存储为计算节点的本地空间</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>student@workstation ~<span class="token punctuation">]</span>$ <span class="token function">ssh</span> root@compute1
<span class="token punctuation">[</span>root@compute1 ~<span class="token punctuation">]</span><span class="token comment"># vim /var/lib/config-data/puppetgenerated/nova_libvirt/etc/nova/nova.conf</span>
<span class="token punctuation">[</span>libvirt<span class="token punctuation">]</span>
<span class="token comment">#images_type=rbd</span>
<span class="token punctuation">[</span>root@compute1 ~<span class="token punctuation">]</span><span class="token comment"># docker restart nova_compute</span>
<span class="token punctuation">[</span>root@compute1 ~<span class="token punctuation">]</span><span class="token comment"># exit</span>
<span class="token punctuation">[</span>student@workstation ~<span class="token punctuation">]</span>$ <span class="token builtin class-name">source</span> architect1-finance-rc
<span class="token punctuation">[</span>student@workstation ~<span class="token punctuation">(</span>architect1-finance<span class="token punctuation">)</span><span class="token punctuation">]</span>$ openstack server create --flavor default --image rhel7 --nic net-id<span class="token operator">=</span>finance-network1 --availability-zone nova:compute1.overcloud.example.com finance-server1
<span class="token punctuation">[</span>student@workstation ~<span class="token punctuation">(</span>architect1-finance<span class="token punctuation">)</span><span class="token punctuation">]</span>$ openstack server list
<span class="token punctuation">[</span>student@workstation ~<span class="token punctuation">(</span>architect1-finance<span class="token punctuation">)</span><span class="token punctuation">]</span>$ <span class="token function">ssh</span> root@compute1
Last login: Sun May <span class="token number">31</span> <span class="token number">19</span>:00:07 <span class="token number">2020</span> from <span class="token number">172.25</span>.250.254
<span class="token comment">#查看云主机的根磁盘已经存放在计算节点本地</span>
<span class="token punctuation">[</span>root@compute1 ~<span class="token punctuation">]</span><span class="token comment"># ls /var/lib/nova/instances/</span>
_base  compute_nodes  e621ca91-9c12-42f5-aa73-3e73547d9d0a  locks
<span class="token punctuation">[</span>root@compute1 ~<span class="token punctuation">]</span><span class="token comment"># ls /var/lib/nova/instances/e621ca91-9c12-42f5-aa73-3e73547d9d0a/</span>
console.log  disk  disk.info
<span class="token comment">#删除云主机，磁盘文件也被删除</span>
<span class="token punctuation">[</span>student@workstation ~<span class="token punctuation">(</span>architect1-finance<span class="token punctuation">)</span><span class="token punctuation">]</span>$ openstack server delete finance-server1
<span class="token punctuation">[</span>student@workstation ~<span class="token punctuation">(</span>architect1-finance<span class="token punctuation">)</span><span class="token punctuation">]</span>$ <span class="token function">ssh</span> root@compute1
Last login: Sun May <span class="token number">31</span> <span class="token number">19</span>:02:02 <span class="token number">2020</span> from <span class="token number">172.25</span>.250.254
<span class="token punctuation">[</span>root@compute1 ~<span class="token punctuation">]</span><span class="token comment"># ls /var/lib/nova/instances/</span>
_base  compute_nodes  locks<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="练习：创建永久存储作为云主机的根磁盘">练习：创建永久存储作为云主机的根磁盘</h4>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@compute1 ~<span class="token punctuation">]</span><span class="token comment"># vim /var/lib/config-data/puppetgenerated/nova_libvirt/etc/nova/nova.conf</span>
<span class="token punctuation">[</span>libvirt<span class="token punctuation">]</span>
<span class="token assign-left variable">images_type</span><span class="token operator">=</span>rbd
<span class="token punctuation">[</span>root@compute1 ~<span class="token punctuation">]</span><span class="token comment"># docker restart nova_compute</span>
<span class="token comment">#将镜像导入到云硬盘中</span>
<span class="token punctuation">[</span>student@workstation ~<span class="token punctuation">(</span>architect1-finance<span class="token punctuation">)</span><span class="token punctuation">]</span>$ openstack volume create --size <span class="token number">10</span> --image rhel7 finance-vol1
<span class="token punctuation">[</span>student@workstation ~<span class="token punctuation">(</span>architect1-finance<span class="token punctuation">)</span><span class="token punctuation">]</span>$ openstack volume list
<span class="token punctuation">[</span>root@controller0 ~<span class="token punctuation">]</span><span class="token comment"># rados -p volumes ls | grep a63d54f5-a68a-486b-9c07-9a735d83dff0</span>
rbd_id.volume-a63d54f5-a68a-486b-9c07-9a735d83dff0
<span class="token comment">#创建虚拟机并使用块存储用作系统盘</span>
<span class="token punctuation">[</span>student@workstation ~<span class="token punctuation">(</span>architect1-finance<span class="token punctuation">)</span><span class="token punctuation">]</span>$ openstack server create --flavor default --volume finance-vol1 --key-name example-keypair --nic net-id<span class="token operator">=</span>finance-network1 finance-server2 --wait
<span class="token punctuation">[</span>student@workstation ~<span class="token punctuation">(</span>architect1-finance<span class="token punctuation">)</span><span class="token punctuation">]</span>$ openstack floating <span class="token function">ip</span> list
<span class="token punctuation">[</span>student@workstation ~<span class="token punctuation">(</span>architect1-finance<span class="token punctuation">)</span><span class="token punctuation">]</span>$ openstack server <span class="token function">add</span> floating <span class="token function">ip</span> finance-server2 <span class="token number">172.25</span>.250.110
<span class="token punctuation">[</span>student@workstation ~<span class="token punctuation">(</span>architect1-finance<span class="token punctuation">)</span><span class="token punctuation">]</span>$ <span class="token function">ssh</span> cloud-user@172.25.250.110
<span class="token punctuation">[</span>cloud-user@finance-server2 ~<span class="token punctuation">]</span>$ <span class="token function">sudo</span> -i
<span class="token punctuation">[</span>root@finance-server2 ~<span class="token punctuation">]</span><span class="token comment"># echo hello > /test</span>
<span class="token punctuation">[</span>root@finance-server2 ~<span class="token punctuation">]</span><span class="token comment"># sync</span>
<span class="token punctuation">[</span>root@finance-server2 ~<span class="token punctuation">]</span><span class="token comment"># exit</span>
<span class="token comment">#删除云主机，查看卷还在</span>
<span class="token punctuation">[</span>student@workstation ~<span class="token punctuation">(</span>architect1-finance<span class="token punctuation">)</span><span class="token punctuation">]</span>$ openstack server delete finance-server2
<span class="token punctuation">[</span>student@workstation ~<span class="token punctuation">(</span>architect1-finance<span class="token punctuation">)</span><span class="token punctuation">]</span>$ <span class="token function">ssh</span> root@controller0
Last login: Sun May <span class="token number">31</span> <span class="token number">19</span>:07:23 <span class="token number">2020</span> from <span class="token number">172.25</span>.250.254
<span class="token punctuation">[</span>root@controller0 ~<span class="token punctuation">]</span><span class="token comment"># rados -p volumes ls | grep a63d54f5-a68a-486b-9c07-9a735d83dff0</span>
rbd_id.volume-a63d54f5-a68a-486b-9c07-9a735d83dff0<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>使用块存储启动虚拟机</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>student@workstation ~<span class="token punctuation">(</span>architect1-finance<span class="token punctuation">)</span><span class="token punctuation">]</span>$ openstack server create --flavor default --volume finance-vol1 --key-name example-keypair --nic net-id<span class="token operator">=</span>finance-network1 finance-server2 --wait
<span class="token punctuation">[</span>student@workstation ~<span class="token punctuation">(</span>architect1-finance<span class="token punctuation">)</span><span class="token punctuation">]</span>$ openstack server <span class="token function">add</span> floating <span class="token function">ip</span> finance-server2 <span class="token number">172.25</span>.250.110
<span class="token punctuation">[</span>student@workstation ~<span class="token punctuation">(</span>architect1-finance<span class="token punctuation">)</span><span class="token punctuation">]</span>$ <span class="token function">ssh</span> cloud-user@172.25.250.110
<span class="token punctuation">[</span>cloud-user@finance-server2 ~<span class="token punctuation">]</span>$ <span class="token function">cat</span> /test
hello<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>为云主机附加卷</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>student@workstation ~<span class="token punctuation">(</span>architect1-finance<span class="token punctuation">)</span><span class="token punctuation">]</span>$ openstack volume create --size <span class="token number">1</span> finance-vol2
<span class="token punctuation">[</span>student@workstation ~<span class="token punctuation">(</span>architect1-finance<span class="token punctuation">)</span><span class="token punctuation">]</span>$ openstack server <span class="token function">add</span> volume finance-server2 finance-vol2
<span class="token punctuation">[</span>student@workstation ~<span class="token punctuation">(</span>architect1-finance<span class="token punctuation">)</span><span class="token punctuation">]</span>$ <span class="token function">ssh</span> cloud-user@172.25.250.110
<span class="token punctuation">[</span>cloud-user@finance-server2 ~<span class="token punctuation">]</span>$ lsblk
NAME   MAJ:MIN RM SIZE RO TYPE MOUNTPOINT
vda    <span class="token number">253</span>:0    <span class="token number">0</span>  10G  <span class="token number">0</span> disk 
└─vda1 <span class="token number">253</span>:1    <span class="token number">0</span>  10G  <span class="token number">0</span> part /
vdb    <span class="token number">253</span>:16   <span class="token number">0</span>   1G  <span class="token number">0</span> disk 
<span class="token punctuation">[</span>student@workstation ~<span class="token punctuation">(</span>architect1-finance<span class="token punctuation">)</span><span class="token punctuation">]</span>$ openstack volume list<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>清除环境</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>student@workstation ~<span class="token punctuation">(</span>architect1-finance<span class="token punctuation">)</span><span class="token punctuation">]</span>$ openstack server delete finance-server2
<span class="token punctuation">[</span>student@workstation ~<span class="token punctuation">(</span>architect1-finance<span class="token punctuation">)</span><span class="token punctuation">]</span>$ openstack volume delete finance-vol1 finance-vol2
<span class="token punctuation">[</span>student@workstation ~<span class="token punctuation">(</span>architect1-finance<span class="token punctuation">)</span><span class="token punctuation">]</span>$ lab storage-compare cleanup<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h2 id="第六章-管理openstack网络">第六章 管理openstack网络</h2>
<h3 id="第一节-描述网络协议类型">第一节 描述网络协议类型</h3>
<ul>
<li>OpenStack 网络服务是 SDN 网络项目，在虚拟环境中提供网络即服务（Networking-as-aService, NaaS）</li>
<li>它实施传统的网络功能，如子网、桥接、VLANs以及开放虚拟网络（Open Virtual Network, OVN）等新技术</li>
<li>OVN 是 RHOSP 的默认 SDN ，由openvswitch社区提出</li>
</ul>
<p>Geneve 简介：</p>
<ul>
<li>创建 VLAN 以分段网络流量，12位的 VLAN ID 限制了虚拟网段在4000个左右</li>
<li>VXLAN（虚拟扩展局域网）解决了VLAN的局限性，24位标头确保更多的虚拟网络数量</li>
<li>VXLAN 不要求改变任何设备的基础架构，但它不兼容其他网络解决方案，如 STT 与 NVGRE</li>
<li>Geneve（Generic Network Virtualization Encapsulation, 通用网络虚拟化封装）通过支持 VXLAN、NVGRE 与 STT 的所有功能来解决这些限制</li>
</ul>
<p><strong>osp13网络架构图</strong></p>
<img src="/2022/06/05/RHOSP13%E5%AE%9E%E9%AA%8C%E6%89%8B%E5%86%8C/20220630131108.png" class title="osp13网络架构图">
<h4 id="练习：云主机网络">练习：云主机网络</h4>
<p>准备环境</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>student@workstation ~<span class="token punctuation">]</span>$ lab networking-protocols setup<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>查看虚拟化节点信息</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>student@workstation ~<span class="token punctuation">(</span>architect1-finance<span class="token punctuation">)</span><span class="token punctuation">]</span>$ openstack hypervisor list
+----+-----------------------------------+-----------------+-------------+-------+
<span class="token operator">|</span> ID <span class="token operator">|</span> Hypervisor Hostname               <span class="token operator">|</span> Hypervisor Type <span class="token operator">|</span> Host IP     <span class="token operator">|</span> State <span class="token operator">|</span>
+----+-----------------------------------+-----------------+-------------+-------+
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> compute1.overcloud.example.com    <span class="token operator">|</span> QEMU            <span class="token operator">|</span> <span class="token number">172.24</span>.1.12 <span class="token operator">|</span> up    <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">2</span> <span class="token operator">|</span> computehci0.overcloud.example.com <span class="token operator">|</span> QEMU            <span class="token operator">|</span> <span class="token number">172.24</span>.1.6  <span class="token operator">|</span> up    <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">3</span> <span class="token operator">|</span> compute0.overcloud.example.com    <span class="token operator">|</span> QEMU            <span class="token operator">|</span> <span class="token number">172.24</span>.1.2  <span class="token operator">|</span> up    <span class="token operator">|</span>
+----+-----------------------------------+-----------------+-------------+-------+<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>创建两个虚拟机</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>student@workstation ~<span class="token punctuation">(</span>architect1-finance<span class="token punctuation">)</span><span class="token punctuation">]</span>$ openstack server create --flavor default --image rhel7 --nic net-id<span class="token operator">=</span>finance-network1 --availability-zone nova:compute0.overcloud.example.com finance-server3
<span class="token punctuation">[</span>student@workstation ~<span class="token punctuation">(</span>architect1-finance<span class="token punctuation">)</span><span class="token punctuation">]</span>$ openstack server create --flavor default --image rhel7 --nic net-id<span class="token operator">=</span>finance-network1 --availability-zone nova:compute0.overcloud.example.com finance-server4
<span class="token punctuation">[</span>student@workstation ~<span class="token punctuation">(</span>architect1-finance<span class="token punctuation">)</span><span class="token punctuation">]</span>$ openstack server list
+--------------------------------------+-----------------+--------+-------------------------------+-------+---------+
<span class="token operator">|</span> ID                                   <span class="token operator">|</span> Name            <span class="token operator">|</span> Status <span class="token operator">|</span> Networks                      <span class="token operator">|</span> Image <span class="token operator">|</span> Flavor  <span class="token operator">|</span>
+--------------------------------------+-----------------+--------+-------------------------------+-------+---------+
<span class="token operator">|</span> 532452cd-4db2-4754-9a8c-96b0e1b243b2 <span class="token operator">|</span> finance-server4 <span class="token operator">|</span> BUILD  <span class="token operator">|</span> finance-network1<span class="token operator">=</span><span class="token number">192.168</span>.1.10 <span class="token operator">|</span> rhel7 <span class="token operator">|</span> default <span class="token operator">|</span>
<span class="token operator">|</span> 9663e1cc-6a4c-482c-97b6-24c7f11b8326 <span class="token operator">|</span> finance-server3 <span class="token operator">|</span> BUILD  <span class="token operator">|</span> finance-network1<span class="token operator">=</span><span class="token number">192.168</span>.1.5  <span class="token operator">|</span> rhel7 <span class="token operator">|</span> default <span class="token operator">|</span>
+--------------------------------------+-----------------+--------+-------------------------------+-------+---------+<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>查看虚拟机的配置文件</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@compute0 ~<span class="token punctuation">]</span><span class="token comment"># virsh list --all</span>
 Id    Name                           State
----------------------------------------------------
 <span class="token number">1</span>     instance-00000002              running
 <span class="token number">2</span>     instance-00000001              running
 <span class="token punctuation">[</span>root@compute0 ~<span class="token punctuation">]</span><span class="token comment"># virsh dumpxml instance-00000002 | grep tap</span>
      <span class="token operator">&lt;</span>target <span class="token assign-left variable">dev</span><span class="token operator">=</span><span class="token string">'tap9e10bd23-f5'</span>/<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>查看网桥信息</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@compute0 ~<span class="token punctuation">]</span><span class="token comment"># ovs-vsctl show</span>
d2399352-a3b5-4559-9868-ec8f97fdf2f5
    Manager <span class="token string">"ptcp:6640:127.0.0.1"</span>
        is_connected: <span class="token boolean">true</span>
    Bridge <span class="token string">"br-eth4"</span>
        fail_mode: standalone
        Port <span class="token string">"eth4"</span>
            Interface <span class="token string">"eth4"</span>
        Port <span class="token string">"br-eth4"</span>
            Interface <span class="token string">"br-eth4"</span>
                type: internal
    Bridge br-trunk
        fail_mode: standalone
        Port <span class="token string">"vlan50"</span>
            tag: <span class="token number">50</span>
            Interface <span class="token string">"vlan50"</span>
                type: internal
        Port <span class="token string">"vlan30"</span>
            tag: <span class="token number">30</span>
            Interface <span class="token string">"vlan30"</span>
                type: internal
        Port <span class="token string">"eth1"</span>
            Interface <span class="token string">"eth1"</span>
        Port br-trunk
            Interface br-trunk
                type: internal
        Port <span class="token string">"vlan10"</span>
            tag: <span class="token number">10</span>
            Interface <span class="token string">"vlan10"</span>
                type: internal
        Port <span class="token string">"vlan20"</span>
            tag: <span class="token number">20</span>
            Interface <span class="token string">"vlan20"</span>
                type: internal
    Bridge br-ex
        fail_mode: standalone
        Port <span class="token string">"eth2"</span>
            Interface <span class="token string">"eth2"</span>
        Port <span class="token string">"patch-provnet-fc5472ee-98d9-4f6b-9bc9-544ca18aefb3-to-br-int"</span>
            Interface <span class="token string">"patch-provnet-fc5472ee-98d9-4f6b-9bc9-544ca18aefb3-to-br-int"</span>
                type: patch
                options: <span class="token punctuation">&#123;</span>peer<span class="token operator">=</span><span class="token string">"patch-br-int-to-provnet-fc5472ee-98d9-4f6b-9bc9-544ca18aefb3"</span><span class="token punctuation">&#125;</span>
        Port br-ex
            Interface br-ex
                type: internal
    Bridge br-int
        fail_mode: secure
        Port <span class="token string">"tapf507830a-f1"</span>
            Interface <span class="token string">"tapf507830a-f1"</span>
        Port <span class="token string">"ovn-85c877-0"</span>
            Interface <span class="token string">"ovn-85c877-0"</span>
                type: geneve
                options: <span class="token punctuation">&#123;</span>csum<span class="token operator">=</span><span class="token string">"true"</span>, <span class="token assign-left variable">key</span><span class="token operator">=</span>flow, <span class="token assign-left variable">remote_ip</span><span class="token operator">=</span><span class="token string">"172.24.2.1"</span><span class="token punctuation">&#125;</span>
        Port <span class="token string">"tapb356e2b4-60"</span>
            Interface <span class="token string">"tapb356e2b4-60"</span>
        Port br-int
            Interface br-int
                type: internal
        Port <span class="token string">"ovn-028ad0-0"</span>
            Interface <span class="token string">"ovn-028ad0-0"</span>
                type: geneve
                options: <span class="token punctuation">&#123;</span>csum<span class="token operator">=</span><span class="token string">"true"</span>, <span class="token assign-left variable">key</span><span class="token operator">=</span>flow, <span class="token assign-left variable">remote_ip</span><span class="token operator">=</span><span class="token string">"172.24.2.6"</span><span class="token punctuation">&#125;</span>
        Port <span class="token string">"patch-br-int-to-provnet-fc5472ee-98d9-4f6b-9bc9-544ca18aefb3"</span>
            Interface <span class="token string">"patch-br-int-to-provnet-fc5472ee-98d9-4f6b-9bc9-544ca18aefb3"</span>
                type: patch
                options: <span class="token punctuation">&#123;</span>peer<span class="token operator">=</span><span class="token string">"patch-provnet-fc5472ee-98d9-4f6b-9bc9-544ca18aefb3-to-br-int"</span><span class="token punctuation">&#125;</span>
        Port <span class="token string">"ovn-cc9fe3-0"</span>
            Interface <span class="token string">"ovn-cc9fe3-0"</span>
                type: geneve
                options: <span class="token punctuation">&#123;</span>csum<span class="token operator">=</span><span class="token string">"true"</span>, <span class="token assign-left variable">key</span><span class="token operator">=</span>flow, <span class="token assign-left variable">remote_ip</span><span class="token operator">=</span><span class="token string">"172.24.2.12"</span><span class="token punctuation">&#125;</span>
        Port <span class="token string">"tap9e10bd23-f5"</span>
            Interface <span class="token string">"tap9e10bd23-f5"</span>
    Bridge <span class="token string">"br-eth3"</span>
        fail_mode: standalone
        Port <span class="token string">"br-eth3"</span>
            Interface <span class="token string">"br-eth3"</span>
                type: internal
        Port <span class="token string">"eth3"</span>
            Interface <span class="token string">"eth3"</span>
    ovs_version: <span class="token string">"2.9.0"</span>
    
<span class="token comment">#列出所有网桥上的端口</span>
<span class="token punctuation">[</span>root@compute0 ~<span class="token punctuation">]</span><span class="token comment"># ovs-vsctl list-ports br-int</span>
ovn-028ad0-0
ovn-85c877-0
ovn-cc9fe3-0
patch-br-int-to-provnet-fc5472ee-98d9-4f6b-9bc9-544ca18aefb3
tap9e10bd23-f5
tapb356e2b4-60
tapf507830a-f1<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>OpenStack网络相关命令：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ openstack hypervisor list：查看 OpenStack 中的 hypervisor（计算节点） 武汉誉天
<span class="token number">2021</span>年RHCA培训专用-请勿传播
$ openstack network list <span class="token punctuation">[</span>--internal<span class="token operator">|</span>--external<span class="token punctuation">]</span>：查看指定项目中的内部或外部网络
$ openstack subnet list：查看全部子网信息
$ openstack port list --network ：查看指定 内部网络中的端口信息
$ openstack router list：查看指定项目中的OVN逻辑路由器
$ openstack security group list：查看指定项目中的安全组规则
$ openstack security group rule list --long -f <span class="token punctuation">[</span>json<span class="token operator">|</span>yaml<span class="token punctuation">]</span>：查看指定安全组规则的详细信息<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="第二节-介绍开放虚拟网络（OVN）">第二节 介绍开放虚拟网络（OVN）</h3>
<p>OVN 架构：</p>
<p>​	1.北向数据库</p>
<ul>
<li>OpenStack 网络使用 OVN ML2 插件（OVN ML2 Plug-in, 即neutron plug-in）</li>
<li>OVN ML2 插件运行在控制节点上，监听 TCP 6641 端口</li>
<li>OVN 北向数据库（OVN Northbound Database）存储从 OVNML2 插件获得的 OVN 逻辑网络配置（logical networkconfiguration）</li>
<li>OVN 北向服务（OVN Northbound Service）从 OVN 北向数据库中转换逻辑网络配置到逻辑数据流中（logical flows）</li>
<li>ovn-northd 将逻辑数据流注入并存储于 OVN Southbound Database 中 ovn-northd 服务运行在控制节点上</li>
</ul>
<p>​	2.南向数据库</p>
<ul>
<li>OVN 南向数据库（OVN Southbound Database）监听 TCP6642 端口</li>
<li>每个 hypervisor 具有其自身的 ovn-controller</li>
<li>OVN 使用逻辑流创建整个网络，逻辑流被分布到每个 hypervisor 节点的 ovn-controller中。ovn-controller 将逻辑流转译成 OpenFlow 流</li>
</ul>
<p><strong>查看控制节点的neutron组件</strong></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@controller0 ~<span class="token punctuation">]</span><span class="token comment"># docker ps | egrep 'ovn|neutron'</span>
a5e85d81d5b9        <span class="token number">172.25</span>.249.200:8787/rhosp13/openstack-ovn-northd:latest                <span class="token string">"/bin/bash /usr/lo..."</span>   <span class="token number">7</span> minutes ago       Up <span class="token number">7</span> minutes                                        ovn-dbs-bundle-docker-0
f15bb0beb920        <span class="token number">172.25</span>.249.200:8787/rhosp13/openstack-ovn-controller:latest            <span class="token string">"kolla_start"</span>            <span class="token number">19</span> months ago       Up <span class="token number">9</span> minutes                                        ovn_controller
11f5ed821071        <span class="token number">172.25</span>.249.200:8787/rhosp13/openstack-neutron-server-ovn:latest        <span class="token string">"kolla_start"</span>            <span class="token number">19</span> months ago       Up <span class="token number">9</span> minutes <span class="token punctuation">(</span>healthy<span class="token punctuation">)</span>                              neutron_api
35f522ad5783        <span class="token number">172.25</span>.249.200:8787/rhosp13/openstack-nova-novncproxy:latest           <span class="token string">"kolla_start"</span>            <span class="token number">19</span> months ago       Up <span class="token number">9</span> minutes <span class="token punctuation">(</span>healthy<span class="token punctuation">)</span>                              nova_vnc_proxy<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>控制节点查看ovn运行的服务</strong></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@controller0 ~<span class="token punctuation">]</span><span class="token comment"># ps -ef | grep ovn</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<img src="/2022/06/05/RHOSP13%E5%AE%9E%E9%AA%8C%E6%89%8B%E5%86%8C/20220630152635.png" class title="controller ovn">
<p><strong>计算节点查看ovn运行的服务</strong></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@compute0 ~<span class="token punctuation">]</span><span class="token comment">#  ps -ef | grep ovn</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<img src="/2022/06/05/RHOSP13%E5%AE%9E%E9%AA%8C%E6%89%8B%E5%86%8C/20220630152835.png" class title="compute ovn">
<p><strong>查看所有open port和ovndb的数据库地址</strong></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@controller0 ~<span class="token punctuation">]</span><span class="token comment"># ovs-vsctl list open</span>
_uuid               <span class="token builtin class-name">:</span> 6c237e8b-5014-42f1-9ac4-cc7728797597
bridges             <span class="token builtin class-name">:</span> <span class="token punctuation">[</span>1d420f80-91e3-44ad-85ff-b311d90a7538, b1eb4d87-1b0b-4541-aca6-e9adefbe8172, b2474c7c-c50c-4a22-8826-f1f9233bf5ab, eb5acfd9-bc1c-444e-9045-8d48aa6d01c5, efed7252-c6fe-487c-a1bc-0b4e6ee9a6d3<span class="token punctuation">]</span>
cur_cfg             <span class="token builtin class-name">:</span> <span class="token number">46</span>
datapath_types      <span class="token builtin class-name">:</span> <span class="token punctuation">[</span>netdev, system<span class="token punctuation">]</span>
db_version          <span class="token builtin class-name">:</span> <span class="token string">"7.15.1"</span>
external_ids        <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>hostname<span class="token operator">=</span><span class="token string">"controller0.overcloud.example.com"</span>, ovn-bridge<span class="token operator">=</span>br-int, ovn-bridge-mappings<span class="token operator">=</span><span class="token string">"datacentre:br-ex,vlanprovider1:br-eth3,vlanprovider2:br-eth4,storage:br-trunk"</span>, ovn-cms-options<span class="token operator">=</span>enable-chassis-as-gw, ovn-encap-ip<span class="token operator">=</span><span class="token string">"172.24.2.1"</span>, ovn-encap-type<span class="token operator">=</span>geneve, ovn-remote<span class="token operator">=</span><span class="token string">"tcp:172.24.1.50:6642"</span>, <span class="token assign-left variable">rundir</span><span class="token operator">=</span><span class="token string">"/var/run/openvswitch"</span>, system-id<span class="token operator">=</span><span class="token string">"85c87734-e866-4225-b305-471357c68b8a"</span><span class="token punctuation">&#125;</span>
iface_types         <span class="token builtin class-name">:</span> <span class="token punctuation">[</span>geneve, gre, internal, lisp, patch, stt, system, tap, vxlan<span class="token punctuation">]</span>
manager_options     <span class="token builtin class-name">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
next_cfg            <span class="token builtin class-name">:</span> <span class="token number">46</span>
other_config        <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
ovs_version         <span class="token builtin class-name">:</span> <span class="token string">"2.9.0"</span>
ssl                 <span class="token builtin class-name">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
statistics          <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
system_type         <span class="token builtin class-name">:</span> rhel
system_version      <span class="token builtin class-name">:</span> <span class="token string">"7.5"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>关联环境变量</strong></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@controller0 ~<span class="token punctuation">]</span><span class="token comment"># export OVN_SB_DB=tcp:172.24.1.50:6642 #南向数据库存放流表信息</span>
<span class="token punctuation">[</span>root@controller0 ~<span class="token punctuation">]</span><span class="token comment"># export OVN_NB_DB=tcp:172.24.1.50:6641 #北向数据库定义网络架构</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p><strong>在北向网络中查看ovn架构信息</strong></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment">#查看所有的switch和router的架构拓扑信息</span>
<span class="token punctuation">[</span>root@controller0 ~<span class="token punctuation">]</span><span class="token comment"># ovn-nbctl show</span>
switch b2cc3860-13f9-4eeb-b328-10dbc1f1b131 <span class="token punctuation">(</span>neutron-d55f6d1e-c29e-4825-8de4-01dd95f8a220<span class="token punctuation">)</span> <span class="token punctuation">(</span>aka provider-storage<span class="token punctuation">)</span>
    port feaf640d-9dcb-4b39-9e00-75761e6f6abd
        type: localport
        addresses: <span class="token punctuation">[</span><span class="token string">"fa:16:3e:61:52:31 172.24.3.200"</span><span class="token punctuation">]</span>
    port provnet-d55f6d1e-c29e-4825-8de4-01dd95f8a220
        type: localnet
        tag: <span class="token number">30</span>
        addresses: <span class="token punctuation">[</span><span class="token string">"unknown"</span><span class="token punctuation">]</span>
switch aca840be-670a-4eb3-9b36-4246c0eabb6c <span class="token punctuation">(</span>neutron-9838d8ed-3e64-4196-87f0-a4bc59059be9<span class="token punctuation">)</span> <span class="token punctuation">(</span>aka lb-mgmt-net<span class="token punctuation">)</span>
    port b7b5ab29-d23e-40cd-ba0b-ff81703e63a6
        type: localport
        addresses: <span class="token punctuation">[</span><span class="token string">"fa:16:3e:12:16:7d 172.23.0.2"</span><span class="token punctuation">]</span>
    port b5d7e4a5-4bfa-4207-aa54-d8c0e0ff7168 <span class="token punctuation">(</span>aka octavia-health-manager-controller0.overcloud.example.com-listen-port<span class="token punctuation">)</span>
        addresses: <span class="token punctuation">[</span><span class="token string">"fa:16:3e:42:7a:a9 172.23.0.5"</span><span class="token punctuation">]</span>
switch c5b32043-cd23-41ac-9197-ea41917870bb <span class="token punctuation">(</span>neutron-e14d713e-c1f5-4800-8543-713563d7e82e<span class="token punctuation">)</span> <span class="token punctuation">(</span>aka production-network1<span class="token punctuation">)</span>
    port f2923c9a-5da8-4e84-847e-1bc3649d5920
        type: localport
        addresses: <span class="token punctuation">[</span><span class="token string">"fa:16:3e:f5:68:fb 192.168.1.2"</span><span class="token punctuation">]</span>
switch 153db687-27fe-4f90-a3f0-2958c373dcc2 <span class="token punctuation">(</span>neutron-7a6556ab-6083-403e-acfc-79caf3873660<span class="token punctuation">)</span> <span class="token punctuation">(</span>aka finance-network1<span class="token punctuation">)</span>
    port f507830a-f124-4c0f-ab1b-8ee6d09de474	<span class="token comment">#finance-server3的port</span>
        addresses: <span class="token punctuation">[</span><span class="token string">"fa:16:3e:55:c4:1c 192.168.1.5"</span><span class="token punctuation">]</span>
    port <span class="token number">42671818</span>-08d4-4a99-bd80-99a452ee40b3	<span class="token comment">#交换机连接路由器的port</span>
        type: localport
        addresses: <span class="token punctuation">[</span><span class="token string">"fa:16:3e:e3:12:fd 192.168.1.2"</span><span class="token punctuation">]</span>
    port ba553e3a-43e9-48cb-afff-fb780c961ae8
        type: router
        router-port: lrp-ba553e3a-43e9-48cb-afff-fb780c961ae8	 <span class="token comment">#路由器端的port</span>
    port 9e10bd23-f5e3-4c4b-8959-047e82882aaf	<span class="token comment">#finance-server4的port</span>
        addresses: <span class="token punctuation">[</span><span class="token string">"fa:16:3e:98:ec:1e 192.168.1.10"</span><span class="token punctuation">]</span>
switch f0f71887-2544-4f29-b46c-04b0aa0b2e52 <span class="token punctuation">(</span>neutron-fc5472ee-98d9-4f6b-9bc9-544ca18aefb3<span class="token punctuation">)</span> <span class="token punctuation">(</span>aka provider-datacentre<span class="token punctuation">)</span>
    port provnet-fc5472ee-98d9-4f6b-9bc9-544ca18aefb3
        type: localnet
        addresses: <span class="token punctuation">[</span><span class="token string">"unknown"</span><span class="token punctuation">]</span>
    port d3a97fff-95de-447c-a962-01b43e0299de
        type: localport
        addresses: <span class="token punctuation">[</span><span class="token string">"fa:16:3e:dc:ab:47"</span><span class="token punctuation">]</span>
    port 624478c2-c249-43dd-9bf1-d81a1e729688
        type: router
        router-port: lrp-624478c2-c249-43dd-9bf1-d81a1e729688
router 9f07c558-a293-40dd-86f7-2551f3c442d3 <span class="token punctuation">(</span>neutron-83a36aa0-977f-4993-a6bb-cc0f1f2ff4a4<span class="token punctuation">)</span> <span class="token punctuation">(</span>aka finance-router1<span class="token punctuation">)</span>
    port lrp-624478c2-c249-43dd-9bf1-d81a1e729688	<span class="token comment">#连接外网的port</span>
        mac: <span class="token string">"fa:16:3e:8b:e8:87"</span>
        networks: <span class="token punctuation">[</span><span class="token string">"172.25.250.103/24"</span><span class="token punctuation">]</span>	<span class="token comment">#外网的网关</span>
        gateway chassis: <span class="token punctuation">[</span>85c87734-e866-4225-b305-471357c68b8a<span class="token punctuation">]</span>
    port lrp-ba553e3a-43e9-48cb-afff-fb780c961ae8	<span class="token comment">#连接finnance-network1的port</span>
        mac: <span class="token string">"fa:16:3e:ce:c1:f2"</span>
        networks: <span class="token punctuation">[</span><span class="token string">"192.168.1.1/24"</span><span class="token punctuation">]</span>	<span class="token comment">#内网的网关</span>
    nat ba3b2264-c843-4d97-9819-c950049e6f65
        external ip: <span class="token string">"172.25.250.103"</span>
        logical ip: <span class="token string">"192.168.1.0/24"</span>
        type: <span class="token string">"snat"</span>
        
<span class="token comment">#查看所有网络的id</span>
<span class="token punctuation">[</span>root@controller0 ~<span class="token punctuation">]</span><span class="token comment"># ovn-nbctl ls-list</span>
153db687-27fe-4f90-a3f0-2958c373dcc2 <span class="token punctuation">(</span>neutron-7a6556ab-6083-403e-acfc-79caf3873660<span class="token punctuation">)</span>
aca840be-670a-4eb3-9b36-4246c0eabb6c <span class="token punctuation">(</span>neutron-9838d8ed-3e64-4196-87f0-a4bc59059be9<span class="token punctuation">)</span>
b2cc3860-13f9-4eeb-b328-10dbc1f1b131 <span class="token punctuation">(</span>neutron-d55f6d1e-c29e-4825-8de4-01dd95f8a220<span class="token punctuation">)</span>
c5b32043-cd23-41ac-9197-ea41917870bb <span class="token punctuation">(</span>neutron-e14d713e-c1f5-4800-8543-713563d7e82e<span class="token punctuation">)</span>
f0f71887-2544-4f29-b46c-04b0aa0b2e52 <span class="token punctuation">(</span>neutron-fc5472ee-98d9-4f6b-9bc9-544ca18aefb3<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>在南向网络中查看ovn架构信息</strong></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@controller0 ~<span class="token punctuation">]</span><span class="token comment"># ovn-sbctl show</span>
Chassis <span class="token string">"8b62a309-b80d-49dc-8ce8-5b000ca2ce83"</span>
    hostname: <span class="token string">"compute0.overcloud.example.com"</span>
    Encap geneve
        ip: <span class="token string">"172.24.2.2"</span>
        options: <span class="token punctuation">&#123;</span>csum<span class="token operator">=</span><span class="token string">"true"</span><span class="token punctuation">&#125;</span>
    Port_Binding <span class="token string">"9e10bd23-f5e3-4c4b-8959-047e82882aaf"</span>
    Port_Binding <span class="token string">"f507830a-f124-4c0f-ab1b-8ee6d09de474"</span>
Chassis <span class="token string">"028ad0fe-55b6-4c8d-b3d4-03e749d6448e"</span>
    hostname: <span class="token string">"computehci0.overcloud.example.com"</span>
    Encap geneve
        ip: <span class="token string">"172.24.2.6"</span>
        options: <span class="token punctuation">&#123;</span>csum<span class="token operator">=</span><span class="token string">"true"</span><span class="token punctuation">&#125;</span>
Chassis <span class="token string">"85c87734-e866-4225-b305-471357c68b8a"</span>
    hostname: <span class="token string">"controller0.overcloud.example.com"</span>
    Encap geneve
        ip: <span class="token string">"172.24.2.1"</span>
        options: <span class="token punctuation">&#123;</span>csum<span class="token operator">=</span><span class="token string">"true"</span><span class="token punctuation">&#125;</span>
    Port_Binding <span class="token string">"cr-lrp-624478c2-c249-43dd-9bf1-d81a1e729688"</span>
    Port_Binding <span class="token string">"b5d7e4a5-4bfa-4207-aa54-d8c0e0ff7168"</span>
Chassis <span class="token string">"cc9fe322-d941-4fff-bd77-7490bc8687a3"</span>
    hostname: <span class="token string">"compute1.overcloud.example.com"</span>
    Encap geneve
        ip: <span class="token string">"172.24.2.12"</span>
        options: <span class="token punctuation">&#123;</span>csum<span class="token operator">=</span><span class="token string">"true"</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>查看安全组规则实现</strong></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment">#查看网络中虚拟机的防火墙规则</span>
<span class="token punctuation">[</span>root@controller0 ~<span class="token punctuation">]</span><span class="token comment">#  ovn-nbctl acl-list switch id</span>
ovn-nbctl: <span class="token string">'acl-list'</span> <span class="token builtin class-name">command</span> takes at <span class="token function">most</span> <span class="token number">1</span> arguments

<span class="token comment">#查看网络端口</span>
<span class="token punctuation">[</span>root@controller0 ~<span class="token punctuation">]</span><span class="token comment"># ovn-nbctl show</span>
    port 9e10bd23-f5e3-4c4b-8959-047e82882aaf	<span class="token comment">#finance-server4的port</span>
        addresses: <span class="token punctuation">[</span><span class="token string">"fa:16:3e:98:ec:1e 192.168.1.10"</span><span class="token punctuation">]</span>

<span class="token comment">#查看路由器上的的防火墙规则</span>
<span class="token punctuation">[</span>root@controller0 ~<span class="token punctuation">]</span><span class="token comment">#  ovn-nbctl acl-list neutron-7a6556ab-6083-403e-acfc-79caf3873660  | grep 9e10bd23-f5e3-4c4b-8959-047e82882aaf</span>
from-lport  <span class="token number">1002</span> <span class="token punctuation">(</span>inport <span class="token operator">==</span> <span class="token string">"9e10bd23-f5e3-4c4b-8959-047e82882aaf"</span> <span class="token operator">&amp;&amp;</span> ip4<span class="token punctuation">)</span> allow-related
from-lport  <span class="token number">1002</span> <span class="token punctuation">(</span>inport <span class="token operator">==</span> <span class="token string">"9e10bd23-f5e3-4c4b-8959-047e82882aaf"</span> <span class="token operator">&amp;&amp;</span> ip4 <span class="token operator">&amp;&amp;</span> ip4.dst <span class="token operator">==</span> <span class="token punctuation">&#123;</span><span class="token number">255.255</span>.255.255, <span class="token number">192.168</span>.1.0/24<span class="token punctuation">&#125;</span> <span class="token operator">&amp;&amp;</span> udp <span class="token operator">&amp;&amp;</span> udp.src <span class="token operator">==</span> <span class="token number">68</span> <span class="token operator">&amp;&amp;</span> udp.dst <span class="token operator">==</span> <span class="token number">67</span><span class="token punctuation">)</span> allow
from-lport  <span class="token number">1002</span> <span class="token punctuation">(</span>inport <span class="token operator">==</span> <span class="token string">"9e10bd23-f5e3-4c4b-8959-047e82882aaf"</span> <span class="token operator">&amp;&amp;</span> ip6<span class="token punctuation">)</span> allow-related
from-lport  <span class="token number">1001</span> <span class="token punctuation">(</span>inport <span class="token operator">==</span> <span class="token string">"9e10bd23-f5e3-4c4b-8959-047e82882aaf"</span> <span class="token operator">&amp;&amp;</span> <span class="token function">ip</span><span class="token punctuation">)</span> drop
  to-lport  <span class="token number">1002</span> <span class="token punctuation">(</span>outport <span class="token operator">==</span> <span class="token string">"9e10bd23-f5e3-4c4b-8959-047e82882aaf"</span> <span class="token operator">&amp;&amp;</span> ip4 <span class="token operator">&amp;&amp;</span> ip4.src <span class="token operator">==</span> <span class="token variable">$as_ip4_952467e9_b667_44ba_adb6_878c2e089308</span><span class="token punctuation">)</span> allow-related
  to-lport  <span class="token number">1002</span> <span class="token punctuation">(</span>outport <span class="token operator">==</span> <span class="token string">"9e10bd23-f5e3-4c4b-8959-047e82882aaf"</span> <span class="token operator">&amp;&amp;</span> ip4 <span class="token operator">&amp;&amp;</span> ip4.src <span class="token operator">==</span> <span class="token number">0.0</span>.0.0/0 <span class="token operator">&amp;&amp;</span> icmp4<span class="token punctuation">)</span> allow-related
  to-lport  <span class="token number">1002</span> <span class="token punctuation">(</span>outport <span class="token operator">==</span> <span class="token string">"9e10bd23-f5e3-4c4b-8959-047e82882aaf"</span> <span class="token operator">&amp;&amp;</span> ip4 <span class="token operator">&amp;&amp;</span> ip4.src <span class="token operator">==</span> <span class="token number">0.0</span>.0.0/0 <span class="token operator">&amp;&amp;</span> tcp <span class="token operator">&amp;&amp;</span> tcp.dst <span class="token operator">==</span> <span class="token number">22</span><span class="token punctuation">)</span> allow-related
  to-lport  <span class="token number">1002</span> <span class="token punctuation">(</span>outport <span class="token operator">==</span> <span class="token string">"9e10bd23-f5e3-4c4b-8959-047e82882aaf"</span> <span class="token operator">&amp;&amp;</span> ip4 <span class="token operator">&amp;&amp;</span> ip4.src <span class="token operator">==</span> <span class="token number">0.0</span>.0.0/0 <span class="token operator">&amp;&amp;</span> tcp <span class="token operator">&amp;&amp;</span> tcp.dst <span class="token operator">==</span> <span class="token number">443</span><span class="token punctuation">)</span> allow-related
  to-lport  <span class="token number">1002</span> <span class="token punctuation">(</span>outport <span class="token operator">==</span> <span class="token string">"9e10bd23-f5e3-4c4b-8959-047e82882aaf"</span> <span class="token operator">&amp;&amp;</span> ip4 <span class="token operator">&amp;&amp;</span> ip4.src <span class="token operator">==</span> <span class="token number">0.0</span>.0.0/0 <span class="token operator">&amp;&amp;</span> tcp <span class="token operator">&amp;&amp;</span> tcp.dst <span class="token operator">==</span> <span class="token number">80</span><span class="token punctuation">)</span> allow-related
  to-lport  <span class="token number">1002</span> <span class="token punctuation">(</span>outport <span class="token operator">==</span> <span class="token string">"9e10bd23-f5e3-4c4b-8959-047e82882aaf"</span> <span class="token operator">&amp;&amp;</span> ip6 <span class="token operator">&amp;&amp;</span> ip6.src <span class="token operator">==</span> <span class="token variable">$as_ip6_952467e9_b667_44ba_adb6_878c2e089308</span><span class="token punctuation">)</span> allow-related
  to-lport  <span class="token number">1001</span> <span class="token punctuation">(</span>outport <span class="token operator">==</span> <span class="token string">"9e10bd23-f5e3-4c4b-8959-047e82882aaf"</span> <span class="token operator">&amp;&amp;</span> <span class="token function">ip</span><span class="token punctuation">)</span> drop

<span class="token comment">#ovs中的插件调用了防火墙的插件来使用防火墙规则</span>
<span class="token punctuation">[</span>root@controller0 ~<span class="token punctuation">]</span><span class="token comment"># lsmod</span>
nf_conntrack          <span class="token number">133053</span>  <span class="token number">8</span> openvswitch,nf_nat,nf_nat_ipv4,nf_nat_ipv6,xt_conntrack,nf_conntrack_netlink,nf_conntrack_ipv4,nf_conntrack_ipv6
<span class="token punctuation">[</span>root@controller0 ~<span class="token punctuation">]</span><span class="token comment"># modinfo nf_conntrack</span>
filename:       /lib/modules/3.10.0-862.9.1.el7.x86_64/kernel/net/netfilter/nf_conntrack.ko.xz<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>查看路由规则实现</strong></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment">#查看路由的id</span>
<span class="token punctuation">[</span>root@controller0 ~<span class="token punctuation">]</span><span class="token comment"># ovn-nbctl lr-list</span>
9f07c558-a293-40dd-86f7-2551f3c442d3 <span class="token punctuation">(</span>neutron-83a36aa0-977f-4993-a6bb-cc0f1f2ff4a4<span class="token punctuation">)</span>
<span class="token comment">#查看路由器上的nat规则</span>
<span class="token punctuation">[</span>root@controller0 ~<span class="token punctuation">]</span><span class="token comment"># ovn-nbctl lr-nat-list neutron-83a36aa0-977f-4993-a6bb-cc0f1f2ff4a4</span>
TYPE             EXTERNAL_IP        LOGICAL_IP            EXTERNAL_MAC         LOGICAL_PORT
snat             <span class="token number">172.25</span>.250.103     <span class="token number">192.168</span>.1.0/24
<span class="token comment">#给虚拟机绑定一个浮动ip</span>
<span class="token punctuation">[</span>student@workstation ~<span class="token punctuation">(</span>architect1-finance<span class="token punctuation">)</span><span class="token punctuation">]</span>$ openstack network list
<span class="token punctuation">[</span>student@workstation ~<span class="token punctuation">(</span>architect1-finance<span class="token punctuation">)</span><span class="token punctuation">]</span>$ openstack floating <span class="token function">ip</span> create provider-datacentre
<span class="token punctuation">[</span>student@workstation ~<span class="token punctuation">(</span>architect1-finance<span class="token punctuation">)</span><span class="token punctuation">]</span>$ openstack floating <span class="token function">ip</span> list
<span class="token punctuation">[</span>student@workstation ~<span class="token punctuation">(</span>architect1-finance<span class="token punctuation">)</span><span class="token punctuation">]</span>$ openstack server <span class="token function">add</span> floating <span class="token function">ip</span> finance-server3 <span class="token number">172.25</span>.250.107
<span class="token comment">#再次查看nat路由信息</span>
<span class="token punctuation">[</span>root@controller0 ~<span class="token punctuation">]</span><span class="token comment"># ovn-nbctl lr-nat-list neutron-83a36aa0-977f-4993-a6bb-cc0f1f2ff4a4</span>
TYPE             EXTERNAL_IP        LOGICAL_IP            EXTERNAL_MAC         LOGICAL_PORT
dnat_and_snat    <span class="token number">172.25</span>.250.107     <span class="token number">192.168</span>.1.5           fa:16:3e:de:5f:40    f507830a-f124-4c0f-ab1b-8ee6d09de474
snat             <span class="token number">172.25</span>.250.103     <span class="token number">192.168</span>.1.0/24<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>在南向网络中查看流表信息</strong></p>
<p>在控制节点查看总的流表信息，来自于数据库对整个网络的汇总信息</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment">#查看云主机在ovs上的port id</span>
<span class="token punctuation">[</span>student@workstation ~<span class="token punctuation">(</span>architect1-finance<span class="token punctuation">)</span><span class="token punctuation">]</span>$ openstack port list
<span class="token operator">|</span> 9e10bd23-f5e3-4c4b-8959-047e82882aaf <span class="token operator">|</span>                                                                
      <span class="token operator">|</span> fa:16:3e:98:ec:1e <span class="token operator">|</span> <span class="token assign-left variable">ip_address</span><span class="token operator">=</span><span class="token string">'192.168.1.10'</span>, <span class="token assign-left variable">subnet_id</span><span class="token operator">=</span><span class="token string">'4836a9dd-e01f-4a33-a971-fa49dec9ffd5'</span>   <span class="token operator">|</span> ACTIVE <span class="token operator">|</span>
<span class="token comment">#或者：</span>
<span class="token punctuation">[</span>root@controller0 ~<span class="token punctuation">]</span><span class="token comment"># ovn-nbctl show</span>
    port 9e10bd23-f5e3-4c4b-8959-047e82882aaf	<span class="token comment">#finance-server4的port</span>
        addresses: <span class="token punctuation">[</span><span class="token string">"fa:16:3e:98:ec:1e 192.168.1.10"</span><span class="token punctuation">]</span>
<span class="token comment">#查看实例对应port的相关信息流</span>
<span class="token punctuation">[</span>root@controller0 ~<span class="token punctuation">]</span><span class="token comment"># ovn-sbctl lflow-list | grep 9e10bd23-f5e3-4c4b-8959-047e82882aaf</span>
<span class="token comment">#查看dhcp分配的所有地址</span>
<span class="token punctuation">[</span>root@controller0 ~<span class="token punctuation">]</span><span class="token comment"># ovn-sbctl lflow-list | grep offerip</span>
<span class="token comment">#查看nat的信息</span>
<span class="token punctuation">[</span>root@controller0 ~<span class="token punctuation">]</span><span class="token comment"># ovn-sbctl lflow-list | grep nat</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在计算节点查看各节点的真实的流表信息，控制节点负责定义网络信息，计算节点的ovn-controller服务收到请求，去实现具体的功能</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@compute1 ~<span class="token punctuation">]</span><span class="token comment"># docker ps | grep ovn</span>
e2c26290b12a        <span class="token number">172.25</span>.249.200:8787/rhosp13/openstack-ovn-controller:latest               <span class="token string">"kolla_start"</span>       <span class="token number">19</span> months ago       Up <span class="token number">34</span> minutes                                 ovn_controller
9aec1c0ab9c5        <span class="token number">172.25</span>.249.200:8787/rhosp13/openstack-neutron-metadata-agent-ovn:latest   <span class="token string">"kolla_start"</span>       <span class="token number">19</span> months ago       Up <span class="token number">34</span> minutes <span class="token punctuation">(</span>healthy<span class="token punctuation">)</span>                       ovn_metadata_agent
<span class="token comment">#在计算节点查看具体的流表信息</span>
<span class="token punctuation">[</span>root@compute1 ~<span class="token punctuation">]</span><span class="token comment"># ovs-ofctl dump-flows br-int | grep nat</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@controller0 ~<span class="token punctuation">]</span><span class="token comment"># ovs-ofctl show br-trunk</span>
OFPT_FEATURES_REPLY <span class="token punctuation">(</span>xid<span class="token operator">=</span>0x2<span class="token punctuation">)</span>: dpid:0000525400010001
n_tables:254, n_buffers:0
capabilities: FLOW_STATS TABLE_STATS PORT_STATS QUEUE_STATS ARP_MATCH_IP
actions: output enqueue set_vlan_vid set_vlan_pcp strip_vlan mod_dl_src mod_dl_dst mod_nw_src mod_nw_dst
 mod_nw_tos mod_tp_src mod_tp_dst
 <span class="token number">1</span><span class="token punctuation">(</span>eth1<span class="token punctuation">)</span>: addr:52:54:00:01:00:01
     config:     <span class="token number">0</span>
     state:      <span class="token number">0</span>
     speed: <span class="token number">0</span> Mbps now, <span class="token number">0</span> Mbps max
 <span class="token number">2</span><span class="token punctuation">(</span>vlan10<span class="token punctuation">)</span>: addr:02:39:8c:88:94:3d
     config:     <span class="token number">0</span>
     state:      <span class="token number">0</span>
     speed: <span class="token number">0</span> Mbps now, <span class="token number">0</span> Mbps max
 <span class="token number">3</span><span class="token punctuation">(</span>vlan20<span class="token punctuation">)</span>: addr:72:04:0c:22:06:e3
     config:     <span class="token number">0</span>
     state:      <span class="token number">0</span>
     speed: <span class="token number">0</span> Mbps now, <span class="token number">0</span> Mbps max
 <span class="token number">4</span><span class="token punctuation">(</span>vlan30<span class="token punctuation">)</span>: addr:62:d2:6c:ea:f8:5b
     config:     <span class="token number">0</span>
     state:      <span class="token number">0</span>
     speed: <span class="token number">0</span> Mbps now, <span class="token number">0</span> Mbps max
 <span class="token number">5</span><span class="token punctuation">(</span>vlan40<span class="token punctuation">)</span>: addr:ee:eb:73:3b:24:15
     config:     <span class="token number">0</span>
     state:      <span class="token number">0</span>
     speed: <span class="token number">0</span> Mbps now, <span class="token number">0</span> Mbps max
 <span class="token number">6</span><span class="token punctuation">(</span>vlan50<span class="token punctuation">)</span>: addr:4e:0b:97:5a:93:2d
     config:     <span class="token number">0</span>
     state:      <span class="token number">0</span>
     speed: <span class="token number">0</span> Mbps now, <span class="token number">0</span> Mbps max
 LOCAL<span class="token punctuation">(</span>br-trunk<span class="token punctuation">)</span>: addr:52:54:00:01:00:01
     config:     <span class="token number">0</span>
     state:      <span class="token number">0</span>
     speed: <span class="token number">0</span> Mbps now, <span class="token number">0</span> Mbps max
OFPT_GET_CONFIG_REPLY <span class="token punctuation">(</span>xid<span class="token operator">=</span>0x4<span class="token punctuation">)</span>: <span class="token assign-left variable">frags</span><span class="token operator">=</span>normal <span class="token assign-left variable">miss_send_len</span><span class="token operator">=</span><span class="token number">0</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>重点说明：带VNI标签的数据包被geneve隧道封装后，走vlan20通讯</strong></p>
<p><strong>查看geneve流量在租户网络vlan20（172.24.2.0/24）中传输</strong></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>student@workstation ~<span class="token punctuation">(</span>architect1-finance<span class="token punctuation">)</span><span class="token punctuation">]</span>$ openstack server list
+--------------------------------------+------+--------+--------------------
-----------+-------+---------+
<span class="token operator">|</span> ID <span class="token operator">|</span> Name <span class="token operator">|</span> Status <span class="token operator">|</span> Networks
<span class="token operator">|</span> Image <span class="token operator">|</span> Flavor <span class="token operator">|</span>
+--------------------------------------+------+--------+--------------------
-----------+-------+---------+
<span class="token operator">|</span> 3b9ef7e8-cd48-4c2f-9b81-60cade80d854 <span class="token operator">|</span> web2 <span class="token operator">|</span> ACTIVE <span class="token operator">|</span> <span class="token assign-left variable">financenetwork1</span><span class="token operator">=</span><span class="token number">192.168</span>.1.12 <span class="token operator">|</span> rhel7 <span class="token operator">|</span> default <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">67445708</span>-c862-40bd-ab21-7cb01875a5b5 <span class="token operator">|</span> web1 <span class="token operator">|</span> ACTIVE <span class="token operator">|</span> <span class="token assign-left variable">financenetwork1</span><span class="token operator">=</span><span class="token number">192.168</span>.1.8 <span class="token operator">|</span> rhel7 <span class="token operator">|</span> default <span class="token operator">|</span>
+--------------------------------------+------+--------+--------------------
-----------+-------+---------+
<span class="token comment">#在计算节点上的vlan20接口上抓包查看</span>
<span class="token punctuation">[</span>root@compute1 ~<span class="token punctuation">]</span><span class="token comment"># tcpdump -ten -i vlan20 | grep ICMP</span>
tcpdump: verbose output suppressed, use -v or -vv <span class="token keyword">for</span> full protocol decode listening on vlan20, link-type EN10MB <span class="token punctuation">(</span>Ethernet<span class="token punctuation">)</span>, capture size <span class="token number">262144</span> bytes e2:6a:ed:98:21:43 <span class="token operator">></span> d2:ed:bc:5d:dc:75, ethertype IPv4 <span class="token punctuation">(</span>0x0800<span class="token punctuation">)</span>, length <span class="token number">156</span>: <span class="token number">172.24</span>.2.12.24438 <span class="token operator">></span> <span class="token number">172.24</span>.2.2.6081: Geneve, Flags <span class="token punctuation">[</span>C<span class="token punctuation">]</span>, vni 0x4, proto TEB <span class="token punctuation">(</span>0x6558<span class="token punctuation">)</span>, options <span class="token punctuation">[</span><span class="token number">8</span> bytes<span class="token punctuation">]</span>: fa:16:3e:ba:a7:84 <span class="token operator">></span> fa:16:3e:b5:7f:df, ethertype IPv4 <span class="token punctuation">(</span>0x0800<span class="token punctuation">)</span>, length <span class="token number">98</span>: <span class="token number">192.168</span>.1.8 <span class="token operator">></span> <span class="token number">192.168</span>.1.12: ICMP <span class="token builtin class-name">echo</span> request, <span class="token function">id</span> <span class="token number">1318</span>, <span class="token function">seq</span> <span class="token number">1</span>, length <span class="token number">64</span> d2:ed:bc:5d:dc:75 <span class="token operator">></span> e2:6a:ed:98:21:43, ethertype IPv4 <span class="token punctuation">(</span>0x0800<span class="token punctuation">)</span>, length <span class="token number">156</span>: <span class="token number">172.24</span>.2.2.25470 <span class="token operator">></span> <span class="token number">172.24</span>.2.12.6081: Geneve, Flags <span class="token punctuation">[</span>C<span class="token punctuation">]</span>, vni 0x4, proto TEB <span class="token punctuation">(</span>0x6558<span class="token punctuation">)</span>, options <span class="token punctuation">[</span><span class="token number">8</span> bytes<span class="token punctuation">]</span>: fa:16:3e:b5:7f:df <span class="token operator">></span> fa:16:3e:ba:a7:84, ethertype IPv4 <span class="token punctuation">(</span>0x0800<span class="token punctuation">)</span>, length <span class="token number">98</span>: <span class="token number">192.168</span>.1.12 <span class="token operator">></span> <span class="token number">192.168</span>.1.8: ICMP <span class="token builtin class-name">echo</span> reply, <span class="token function">id</span> <span class="token number">1318</span>, <span class="token function">seq</span> <span class="token number">1</span>, length <span class="token number">64</span>
<span class="token comment">#说明：</span>
finance-network1的VNI为0x4<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>创建两个网络，他们有各自的VNI 标签，并且web2和web3在不同的计算节点上，它们之间互访走 vlan20</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>student@workstation ~<span class="token punctuation">(</span>developer1-finance<span class="token punctuation">)</span><span class="token punctuation">]</span>$ openstack server list
+--------------------------------------+------+--------+--------------------
-----------+-------+---------+
<span class="token operator">|</span> ID <span class="token operator">|</span> Name <span class="token operator">|</span> Status <span class="token operator">|</span> Networks
<span class="token operator">|</span> Image <span class="token operator">|</span> Flavor <span class="token operator">|</span>
+--------------------------------------+------+--------+--------------------
-----------+-------+---------+
<span class="token operator">|</span> 18a4252c-969e-4bbf-90e1-c81765a3fc5a <span class="token operator">|</span> web3 <span class="token operator">|</span> ACTIVE <span class="token operator">|</span> <span class="token assign-left variable">financenetwork2</span><span class="token operator">=</span><span class="token number">192.168</span>.2.4 <span class="token operator">|</span> rhel7 <span class="token operator">|</span> default <span class="token operator">|</span>
<span class="token operator">|</span> 3b9ef7e8-cd48-4c2f-9b81-60cade80d854 <span class="token operator">|</span> web2 <span class="token operator">|</span> ACTIVE <span class="token operator">|</span> <span class="token assign-left variable">financenetwork1</span><span class="token operator">=</span><span class="token number">192.168</span>.1.12 <span class="token operator">|</span> rhel7 <span class="token operator">|</span> default <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">67445708</span>-c862-40bd-ab21-7cb01875a5b5 <span class="token operator">|</span> web1 <span class="token operator">|</span> ACTIVE <span class="token operator">|</span> <span class="token assign-left variable">financenetwork1</span><span class="token operator">=</span><span class="token number">192.168</span>.1.8 <span class="token operator">|</span> rhel7 <span class="token operator">|</span> default <span class="token operator">|</span>
+--------------------------------------+------+--------+--------------------
-----------+-------+---------+
<span class="token punctuation">[</span>root@compute0 ~<span class="token punctuation">]</span><span class="token comment"># tcpdump -ten -i vlan20 | grep ICMP</span>
tcpdump: verbose output suppressed, use -v or -vv <span class="token keyword">for</span> full protocol decode listening on vlan20, link-type EN10MB <span class="token punctuation">(</span>Ethernet<span class="token punctuation">)</span>, capture size <span class="token number">262144</span> bytes e2:6a:ed:98:21:43 <span class="token operator">></span> d2:ed:bc:5d:dc:75, ethertype IPv4 <span class="token punctuation">(</span>0x0800<span class="token punctuation">)</span>, length <span class="token number">156</span>: <span class="token number">172.24</span>.2.12.29342 <span class="token operator">></span> <span class="token number">172.24</span>.2.2.6081: Geneve, Flags <span class="token punctuation">[</span>C<span class="token punctuation">]</span>, vni 0x4, proto TEB <span class="token punctuation">(</span>0x6558<span class="token punctuation">)</span>, options <span class="token punctuation">[</span><span class="token number">8</span> bytes<span class="token punctuation">]</span>: fa:16:3e:1b:08:3e <span class="token operator">></span> fa:16:3e:b5:7f:df, ethertype IPv4 <span class="token punctuation">(</span>0x0800<span class="token punctuation">)</span>, length <span class="token number">98</span>: <span class="token number">192.168</span>.2.4 <span class="token operator">></span> <span class="token number">192.168</span>.1.12: ICMP <span class="token builtin class-name">echo</span> request, <span class="token function">id</span> <span class="token number">1341</span>, <span class="token function">seq</span> <span class="token number">1</span>, length <span class="token number">64</span> d2:ed:bc:5d:dc:75 <span class="token operator">></span> e2:6a:ed:98:21:43, ethertype IPv4 <span class="token punctuation">(</span>0x0800<span class="token punctuation">)</span>, length <span class="token number">156</span>: <span class="token number">172.24</span>.2.2.40524 <span class="token operator">></span> <span class="token number">172.24</span>.2.12.6081: Geneve, Flags <span class="token punctuation">[</span>C<span class="token punctuation">]</span>, vni 0x6, proto TEB <span class="token punctuation">(</span>0x6558<span class="token punctuation">)</span>, options <span class="token punctuation">[</span><span class="token number">8</span> bytes<span class="token punctuation">]</span>: fa:16:3e:44:47:9c <span class="token operator">></span> fa:16:3e:05:13:ab, ethertype IPv4 <span class="token punctuation">(</span>0x0800<span class="token punctuation">)</span>, length <span class="token number">98</span>: <span class="token number">192.168</span>.1.12 <span class="token operator">></span> <span class="token number">192.168</span>.2.4: ICMP <span class="token builtin class-name">echo</span> reply, <span class="token function">id</span> <span class="token number">1341</span>, <span class="token function">seq</span> <span class="token number">1</span>, length <span class="token number">64</span>
<span class="token comment">#说明：</span>
finance-network1 的VNI标签是0x4
finance-network2 的VNI标签是0x6<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>OVN DHCP：</strong></p>
<ul>
<li>OVN 实施 DHCPv4，不需要 DHCP 代理（DHCP agent）虚拟网络不再需要 DHCP 命名空间 （namespace）或 dnsmasq进程</li>
<li>运行 ovn-controller 的每个计算节点都配置了 DHCPv4 选项（DHCPv4 options），这意味着 DHCP 支持完全分布式，来自虚拟机实例的 DHCP 请求由 ovn-controller 处理</li>
<li>OVN 北向数据库中的 DHCP_Options 表存储 DHCP 选项如果 enable_dhcp 选项设为True，则数 据库会在创建子网时新建一个条目</li>
<li>DHCP_Options 表 options 列中存储的 DHCPv4 选项包括 ovncontroller 在接收 DHCPv4 请求时 发出的回复</li>
</ul>
<p>$ ovn-nbctl list DHCP_Options：查看 OVN 北向数据库中的 DHCP_Options 表</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@controller0 ~<span class="token punctuation">]</span><span class="token comment"># ovn-nbctl list DHCP_Options</span>
_uuid               <span class="token builtin class-name">:</span> 0207ac05-c912-4897-bf63-abafa00381be
cidr                <span class="token builtin class-name">:</span> <span class="token string">"172.24.3.0/24"</span>
external_ids        <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span><span class="token string">"neutron:revision_number"</span><span class="token operator">=</span><span class="token string">"0"</span>, <span class="token assign-left variable">subnet_id</span><span class="token operator">=</span><span class="token string">"6e5af9b0-67ef-4e1e-9eda-7d6633091d11"</span><span class="token punctuation">&#125;</span>
options             <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>classless_static_route<span class="token operator">=</span><span class="token string">"&#123;169.254.169.254/32,172.24.3.200, 0.0.0.0/0,172.24.3.1&#125;"</span>, <span class="token assign-left variable">dns_server</span><span class="token operator">=</span><span class="token string">"&#123;172.25.250.254, 8.8.8.8&#125;"</span>, <span class="token assign-left variable">lease_time</span><span class="token operator">=</span><span class="token string">"43200"</span>, <span class="token assign-left variable">mtu</span><span class="token operator">=</span><span class="token string">"1500"</span>, <span class="token assign-left variable">router</span><span class="token operator">=</span><span class="token string">"172.24.3.1"</span>, <span class="token assign-left variable">server_id</span><span class="token operator">=</span><span class="token string">"172.24.3.1"</span>, <span class="token assign-left variable">server_mac</span><span class="token operator">=</span><span class="token string">"fa:16:3e:59:b6:54"</span><span class="token punctuation">&#125;</span>

_uuid               <span class="token builtin class-name">:</span> 1cb7d6e2-66ee-4d2e-8478-6ac14a4bbcb0
cidr                <span class="token builtin class-name">:</span> <span class="token string">"172.23.0.0/16"</span>
external_ids        <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span><span class="token string">"neutron:revision_number"</span><span class="token operator">=</span><span class="token string">"0"</span>, <span class="token assign-left variable">subnet_id</span><span class="token operator">=</span><span class="token string">"e0db6f1e-70be-4360-8210-0435a47e3a88"</span><span class="token punctuation">&#125;</span>
options             <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>classless_static_route<span class="token operator">=</span><span class="token string">"&#123;169.254.169.254/32,172.23.0.2, 0.0.0.0/0,172.23.0.1&#125;"</span>, <span class="token assign-left variable">dns_server</span><span class="token operator">=</span><span class="token string">"&#123;172.25.250.254, 8.8.8.8&#125;"</span>, <span class="token assign-left variable">lease_time</span><span class="token operator">=</span><span class="token string">"43200"</span>, <span class="token assign-left variable">mtu</span><span class="token operator">=</span><span class="token string">"1442"</span>, <span class="token assign-left variable">router</span><span class="token operator">=</span><span class="token string">"172.23.0.1"</span>, <span class="token assign-left variable">server_id</span><span class="token operator">=</span><span class="token string">"172.23.0.1"</span>, <span class="token assign-left variable">server_mac</span><span class="token operator">=</span><span class="token string">"fa:16:3e:a8:ab:a4"</span><span class="token punctuation">&#125;</span>

_uuid               <span class="token builtin class-name">:</span> c7a78dee-18d1-43f0-a915-d472302f1750
cidr                <span class="token builtin class-name">:</span> <span class="token string">"192.168.1.0/24"</span>
external_ids        <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span><span class="token string">"neutron:revision_number"</span><span class="token operator">=</span><span class="token string">"0"</span>, <span class="token assign-left variable">subnet_id</span><span class="token operator">=</span><span class="token string">"f0c54c6a-5094-4386-9e97-b8564ba31a93"</span><span class="token punctuation">&#125;</span>
options             <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>classless_static_route<span class="token operator">=</span><span class="token string">"&#123;169.254.169.254/32,192.168.1.2, 0.0.0.0/0,192.168.1.1&#125;"</span>, <span class="token assign-left variable">dns_server</span><span class="token operator">=</span><span class="token string">"&#123;172.25.250.254&#125;"</span>, <span class="token assign-left variable">lease_time</span><span class="token operator">=</span><span class="token string">"43200"</span>, <span class="token assign-left variable">mtu</span><span class="token operator">=</span><span class="token string">"1442"</span>, <span class="token assign-left variable">router</span><span class="token operator">=</span><span class="token string">"192.168.1.1"</span>, <span class="token assign-left variable">server_id</span><span class="token operator">=</span><span class="token string">"192.168.1.1"</span>, <span class="token assign-left variable">server_mac</span><span class="token operator">=</span><span class="token string">"fa:16:3e:91:98:f6"</span><span class="token punctuation">&#125;</span>

_uuid               <span class="token builtin class-name">:</span> 9a09543e-f937-4110-bc86-dc6a7464ba53
cidr                <span class="token builtin class-name">:</span> <span class="token string">"192.168.1.0/24"</span>
external_ids        <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span><span class="token string">"neutron:revision_number"</span><span class="token operator">=</span><span class="token string">"0"</span>, <span class="token assign-left variable">subnet_id</span><span class="token operator">=</span><span class="token string">"4836a9dd-e01f-4a33-a971-fa49dec9ffd5"</span><span class="token punctuation">&#125;</span>
options             <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>classless_static_route<span class="token operator">=</span><span class="token string">"&#123;169.254.169.254/32,192.168.1.2, 0.0.0.0/0,192.168.1.1&#125;"</span>, <span class="token assign-left variable">dns_server</span><span class="token operator">=</span><span class="token string">"&#123;172.25.250.254&#125;"</span>, <span class="token assign-left variable">lease_time</span><span class="token operator">=</span><span class="token string">"43200"</span>, <span class="token assign-left variable">mtu</span><span class="token operator">=</span><span class="token string">"1442"</span>, <span class="token assign-left variable">router</span><span class="token operator">=</span><span class="token string">"192.168.1.1"</span>, <span class="token assign-left variable">server_id</span><span class="token operator">=</span><span class="token string">"192.168.1.1"</span>, <span class="token assign-left variable">server_mac</span><span class="token operator">=</span><span class="token string">"fa:16:3e:9f:1a:b5"</span><span class="token punctuation">&#125;</span>
<span class="token punctuation">[</span>root@compute0 ~<span class="token punctuation">]</span><span class="token comment"># ip netns ls</span>
ovnmeta-b356e2b4-6708-4829-87c5-4386e6adc10b <span class="token punctuation">(</span>id: <span class="token number">0</span><span class="token punctuation">)</span>
<span class="token punctuation">[</span>root@compute0 ~<span class="token punctuation">]</span><span class="token comment"># ip netns exec ovnmeta-b356e2b4-6708-4829-87c5-4386e6adc10b ip a</span>
<span class="token number">1</span>: lo: <span class="token operator">&lt;</span>LOOPBACK,UP,LOWER_UP<span class="token operator">></span> mtu <span class="token number">65536</span> qdisc noqueue state UNKNOWN group default qlen <span class="token number">1000</span>
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet <span class="token number">127.0</span>.0.1/8 scope <span class="token function">host</span> lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope <span class="token function">host</span> 
       valid_lft forever preferred_lft forever
<span class="token number">2</span>: tapb356e2b4-61@if21: <span class="token operator">&lt;</span>BROADCAST,MULTICAST,UP,LOWER_UP<span class="token operator">></span> mtu <span class="token number">1500</span> qdisc noqueue state UP group default qlen <span class="token number">1000</span>
    link/ether fa:16:3e:e3:12:fd brd ff:ff:ff:ff:ff:ff link-netnsid <span class="token number">0</span>
    inet <span class="token number">192.168</span>.1.2/24 brd <span class="token number">192.168</span>.1.255 scope global tapb356e2b4-61
       valid_lft forever preferred_lft forever
    inet <span class="token number">169.254</span>.169.254/16 brd <span class="token number">169.254</span>.255.255 scope global tapb356e2b4-61
       valid_lft forever preferred_lft forever<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>OVN/OVS 相关命令汇总：</strong></p>
<p>使用如下命令时，需指定OVN_NB_DB或OVN_SB_DB 环境变量</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">export</span> <span class="token assign-left variable">OVN_SB_DB</span><span class="token operator">=</span>tcp:172.24.1.50:6642
<span class="token builtin class-name">export</span> <span class="token assign-left variable">OVN_NB_DB</span><span class="token operator">=</span>tcp:172.24.1.50:6641<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p><strong>北向数据库（OVN Northbound Database）相关命令：</strong></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ ovs-vsctl list Open_vSwitch：查看 OVN 北向与南向数据库ovn-remote 参数
$ ovn-nbctl show <span class="token punctuation">[</span><span class="token operator">&lt;</span>ovn_logical_switch<span class="token operator">>|</span><span class="token operator">&lt;</span>ovn_logical_router<span class="token operator">></span><span class="token punctuation">]</span>：查看 OVN 北向数据库的逻辑交换机与路由器的信息
$ ovn-nbctl ls-list：查看 OVN 逻辑交换机
$ ovn-nbctl lr-list：查看 OVN 逻辑路由器
$ ovn-nbctl lsp-list <span class="token operator">&lt;</span>ovn_logical_switch<span class="token operator">></span>：查看 OVN 逻辑交换机端口
$ ovn-nbctl lrp-list <span class="token operator">&lt;</span>ovn_logical_router<span class="token operator">></span>：查看 OVN 逻辑路由器端口
$ ovn-nbctl lr-route-list <span class="token operator">&lt;</span>ovn_logical_router<span class="token operator">></span>：查看 OVN 逻辑路由器的路由信息
$ ovn-nbctl lr-nat-list <span class="token operator">&lt;</span>ovn_logical_router<span class="token operator">></span>：查看 OVN 逻辑路由器的 NAT 信息
$ ovn-nbctl dhcp-options-list：查看 OVN 的 DHCP 信息
$ ovn-nbctl dhcp-options-get-options <span class="token operator">&lt;</span>dhcp_options_uuid<span class="token operator">></span>：查看指定 DHCP 的详细信息
$ ovn-nbctl list <span class="token operator">&lt;</span>ovn_nb_db_table<span class="token operator">></span>：查看 OVN 北向数据库的指定表
$ ovn-nbctl acl-list <span class="token operator">&lt;</span>ovn_logical_switch<span class="token operator">></span>：查看 OVN 逻辑交换机的 ACL 规则（安全组规则）<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>OVN 南向数据库（OVN Southbound Database）相关命令：</strong></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ ovn-sbctl show：查看OVN南向数据库的信息
$ ovn-sbctl lflow-list：查看 OVN 南向数据库的逻辑流信息
$ ovn-sbctl list <span class="token punctuation">[</span>Logical_Flow<span class="token operator">|</span>Port_Binding<span class="token operator">|</span>Chassis<span class="token punctuation">]</span>：查看OVN南向数据库中指定表的详细信息，如逻辑流表、端口绑定表等<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p><strong>OVS 与 OpenFlow 相关命令：</strong></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ ovs-vsctl show：查看 OVS 网桥与端口的详细信息
$ ovs-ofctl show <span class="token punctuation">[</span><span class="token operator">&lt;</span>ovs_switch<span class="token operator">></span><span class="token punctuation">]</span>：查看OVS网桥与端口的flow信息
$ ovs-ofctl dump-ports-desc <span class="token operator">&lt;</span>ovs_switch<span class="token operator">></span>：查看OVS网桥的端口列表详情
$ ovs-ofctl dump-tables <span class="token operator">&lt;</span>ovs_switch<span class="token operator">></span>：查看OVS的OpenFlow流表
$ ovs-ofctl dump-flows <span class="token operator">&lt;</span>ovs_switch<span class="token operator">></span>：查看OVS的OpenFlow流表<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
]]></content>
      <categories>
        <category>学习</category>
      </categories>
      <tags>
        <tag>RHCA</tag>
        <tag>openstack</tag>
      </tags>
  </entry>
  <entry>
    <title>复旦CTJ</title>
    <url>/2022/03/05/%E5%A4%8D%E6%97%A6CTJ/</url>
    <content><![CDATA[<h1>记录ctj三战复旦<mark class="label ">403</mark></h1>
<h2 id="金专妥妥有书读">金专妥妥有书读</h2>
<div class="note default"><h4 id="《重生之我在上外贸》-mark-class-label-default-QAQ-恭喜ctj即将上岸（一定！）数院调剂加油！-mark">《重生之我在上外贸》  <s><mark class="label default">QAQ 恭喜ctj即将上岸（一定！）数院调剂加油！</mark></s></h4>
<span id="more"></span>
<ul>
<li>但是今年是真的卷啊！！<em><mark class="label warning">预估排名</mark></em></li>
</ul>
<!-- <img src="3.jpg" width="30%" height="30%"  style="margin: 0 auto;"/> -->
<!--![卷](6.jpg "太卷啦")-->
<img src="/2022/03/05/%E5%A4%8D%E6%97%A6CTJ/6.jpg" class title="太卷啦">
<ul>
<li>其中还不乏有内鬼搞心态=-=</li>
</ul>
<!--
<img src="1.jpg" width="30%" height="30%" style="display:inline-block;"/>
<img src="2.jpg" width="30%" height="30%" style="display:inline-block;margin-left:10px;"/>
-->
<div class="group-picture"><div class="group-picture-row"><div class="group-picture-column"><img src="/2022/03/05/%E5%A4%8D%E6%97%A6CTJ/1.jpg" class title="内鬼1！"></div><div class="group-picture-column"><img src="/2022/03/05/%E5%A4%8D%E6%97%A6CTJ/2.jpg" class title="内鬼2！"></div></div></div>
<ul>
<li>预计扩招还挺有机会的。</li>
</ul>
<!--<img src="5.jpg" width="30%" height="30%"  style="margin: 0 auto;"/>-->
<!--![扩招](5.jpg "扩招！")-->
<img src="/2022/03/05/%E5%A4%8D%E6%97%A6CTJ/5.jpg" class title="扩招">
<ul>
<li>金融确实太卷了，粥粥还要考啊？hhh</li>
</ul>
<!--<img src="4.jpg" width="30%" height="30%"  style="margin: 0 auto;"/>-->
<!--![预估分数线](4.jpg "预估分数线")-->
<img src="/2022/03/05/%E5%A4%8D%E6%97%A6CTJ/4.jpg" class title="预估分数线">
<ul>
<li>还有一周出校线啦！更新一波最新补全成绩：</li>
</ul>
<!--![补全成绩](7.jpg "补全成绩]")-->
<img src="/2022/03/05/%E5%A4%8D%E6%97%A6CTJ/7.jpg" class title="预估分数线">
<ul>
<li>国家线高得离谱啊，今年是什么，意在让大家积极就业么=-=</li>
</ul>
<!--![国家线](10.jpg "国家线]")-->
<img src="/2022/03/05/%E5%A4%8D%E6%97%A6CTJ/10.jpg" class title="国家线">
<ul>
<li>清华这应用统计数三划线140？<s><mark class="label default">山东师范也太可怜了orz</mark></s></li>
</ul>
<div class="group-picture"><div class="group-picture-row"><div class="group-picture-column"><img src="/2022/03/05/%E5%A4%8D%E6%97%A6CTJ/8.jpg" class title="清华"></div></div><div class="group-picture-row"><div class="group-picture-column"><img src="/2022/03/05/%E5%A4%8D%E6%97%A6CTJ/9.jpg" class title="山东师范"></div></div></div>
<ul>
<li>校线已出，“内部消息”三院同线：<mark class="label ">400</mark>！上岸上岸！</li>
</ul>
<!--![复旦校线](11.jpg "复旦校线")-->
<img src="/2022/03/05/%E5%A4%8D%E6%97%A6CTJ/11.jpg" class title="复旦校线">
<ul>
<li>明天qxd数院复试，加油呀尽力就好了~27进16冲！</li>
</ul>
<div class="group-picture"><div class="group-picture-row"><div class="group-picture-column"><img src="/2022/03/05/%E5%A4%8D%E6%97%A6CTJ/12.jpg" class title="调剂通知"></div><div class="group-picture-column"><img src="/2022/03/05/%E5%A4%8D%E6%97%A6CTJ/13.jpg" class title="调剂名单"></div></div></div>
<ul>
<li>最后的最后调剂至上外贸，恭喜~ 在往后的日子里继续加油吧，要相信自己。<br>
<img src="/2022/03/05/%E5%A4%8D%E6%97%A6CTJ/14.jpg" class title="上外贸录取"></li>
</ul>
</div>]]></content>
      <categories>
        <category>好友</category>
      </categories>
      <tags>
        <tag>CTJ</tag>
      </tags>
  </entry>
</search>
